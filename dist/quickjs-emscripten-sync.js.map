{"version":3,"file":"quickjs-emscripten-sync.js","sources":["../src/vmmap.ts","../src/util.ts","../src/vmutil.ts","../src/marshal/properties.ts","../src/marshal/function.ts","../src/marshal/object.ts","../src/marshal/primitive.ts","../src/marshal/symbol.ts","../src/marshal/index.ts","../src/unmarshal/properties.ts","../src/unmarshal/function.ts","../src/unmarshal/object.ts","../src/unmarshal/primitive.ts","../src/unmarshal/symbol.ts","../src/unmarshal/index.ts","../src/wrapper.ts","../src/default.ts","../src/index.ts"],"sourcesContent":["import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport default class VMMap {\n  vm: QuickJSVm;\n  _map1: Map<any, number> = new Map();\n  _map2: Map<any, number> = new Map();\n  _map3: Map<number, QuickJSHandle> = new Map();\n  _map4: Map<number, QuickJSHandle> = new Map();\n  _counterMap: Map<number, any> = new Map();\n  _disposables: Set<QuickJSHandle> = new Set();\n  _mapGet: QuickJSHandle;\n  _mapSet: QuickJSHandle;\n  _mapDelete: QuickJSHandle;\n  _mapClear: QuickJSHandle;\n  _counter = 0;\n\n  constructor(vm: QuickJSVm) {\n    this.vm = vm;\n\n    const result = vm\n      .unwrapResult(\n        vm.evalCode(`() => {\n        const mapSym = new Map();\n        let map = new WeakMap();\n        let map2 = new WeakMap();\n        const isObj = o => typeof o === \"object\" && o !== null || typeof o === \"function\";\n        return {\n          get: key => mapSym.get(key) ?? map.get(key) ?? map2.get(key) ?? -1,\n          set: (key, value, key2) => {\n            if (typeof key === \"symbol\") mapSym.set(key, value);\n            if (isObj(key)) map.set(key, value);\n            if (isObj(key2)) map2.set(key2, value);\n          },\n          delete: (key, key2) => {\n            mapSym.delete(key);\n            map.delete(key);\n            map2.delete(key2);\n          },\n          clear: () => {\n            mapSym.clear();\n            map = new WeakMap();\n            map2 = new WeakMap();\n          }\n        };\n      }`)\n      )\n      .consume((fn) => this._call(fn, undefined));\n\n    this._mapGet = vm.getProp(result, \"get\");\n    this._mapSet = vm.getProp(result, \"set\");\n    this._mapDelete = vm.getProp(result, \"delete\");\n    this._mapClear = vm.getProp(result, \"clear\");\n\n    result.dispose();\n\n    this._disposables.add(this._mapGet);\n    this._disposables.add(this._mapSet);\n    this._disposables.add(this._mapDelete);\n    this._disposables.add(this._mapClear);\n  }\n\n  set(\n    key: any,\n    handle: QuickJSHandle,\n    key2?: any,\n    handle2?: QuickJSHandle\n  ): boolean {\n    if (!handle.alive || (handle2 && !handle2.alive)) return false;\n\n    const v = this.get(key) ?? this.get(key2);\n    if (v) {\n      // handle and handle2 are unused so they should be disposed\n      return v === handle || v === handle2;\n    }\n\n    const counter = this._counter++;\n    this._map1.set(key, counter);\n    this._map3.set(counter, handle);\n    this._counterMap.set(counter, key);\n    if (key2) {\n      this._map2.set(key2, counter);\n      if (handle2) {\n        this._map4.set(counter, handle2);\n      }\n    }\n\n    this.vm.newNumber(counter).consume((c) => {\n      this._call(\n        this._mapSet,\n        undefined,\n        handle,\n        c,\n        handle2 ?? this.vm.undefined\n      );\n    });\n\n    return true;\n  }\n\n  merge(\n    iteratable:\n      | Iterable<\n          | [any, QuickJSHandle | undefined]\n          | [any, QuickJSHandle | undefined, any, QuickJSHandle | undefined]\n        >\n      | undefined\n  ) {\n    if (!iteratable) return;\n    for (const iter of iteratable) {\n      if (!iter) continue;\n      if (iter[1]) {\n        this.set(iter[0], iter[1], iter[2], iter[3]);\n      }\n    }\n  }\n\n  get(key: any) {\n    const num = this._map1.get(key) ?? this._map2.get(key);\n    const handle = typeof num === \"number\" ? this._map3.get(num) : undefined;\n\n    if (!handle) return;\n    if (!handle.alive) {\n      this.delete(key);\n      return;\n    }\n\n    return handle;\n  }\n\n  getByHandle(handle: QuickJSHandle) {\n    if (!handle.alive) {\n      return;\n    }\n    return this._counterMap.get(\n      this.vm.getNumber(this._call(this._mapGet, undefined, handle))\n    );\n  }\n\n  has(key: any) {\n    return !!this.get(key);\n  }\n\n  hasHandle(handle: QuickJSHandle) {\n    return typeof this.getByHandle(handle) !== \"undefined\";\n  }\n\n  delete(key: any, dispose?: boolean) {\n    const num = this._map1.get(key) ?? this._map2.get(key);\n    if (typeof num === \"undefined\") return;\n\n    const handle = this._map3.get(num);\n    const handle2 = this._map4.get(num);\n    this._call(\n      this._mapDelete,\n      undefined,\n      ...[handle, handle2].filter((h): h is QuickJSHandle => !!h?.alive)\n    );\n\n    this._map1.delete(key);\n    this._map2.delete(key);\n    this._map3.delete(num);\n    this._map4.delete(num);\n\n    for (const [k, v] of this._map1) {\n      if (v === num) {\n        this._map1.delete(k);\n        break;\n      }\n    }\n\n    for (const [k, v] of this._map2) {\n      if (v === num) {\n        this._map2.delete(k);\n        break;\n      }\n    }\n\n    for (const [k, v] of this._counterMap) {\n      if (v === key) {\n        this._counterMap.delete(k);\n        break;\n      }\n    }\n\n    if (dispose) {\n      if (handle?.alive) handle.dispose();\n      if (handle2?.alive) handle2.dispose();\n    }\n  }\n\n  deleteByHandle(handle: QuickJSHandle, dispose?: boolean) {\n    const key = this.getByHandle(handle);\n    if (typeof key !== \"undefined\") {\n      this.delete(key, dispose);\n    }\n  }\n\n  clear() {\n    this._counter = 0;\n    this._map1.clear();\n    this._map2.clear();\n    this._map3.clear();\n    this._map4.clear();\n    this._counterMap.clear();\n    if (this._mapClear.alive) {\n      this._call(this._mapClear, undefined);\n    }\n  }\n\n  dispose() {\n    for (const v of this._disposables.values()) {\n      if (v.alive) {\n        v.dispose();\n      }\n    }\n    for (const v of this._map3.values()) {\n      if (v.alive) {\n        v.dispose();\n      }\n    }\n    for (const v of this._map4.values()) {\n      if (v.alive) {\n        v.dispose();\n      }\n    }\n    this._disposables.clear();\n    this.clear();\n  }\n\n  get size() {\n    return this._map1.size;\n  }\n\n  [Symbol.iterator](): Iterator<\n    [any, QuickJSHandle, any, QuickJSHandle | undefined]\n  > {\n    const keys = this._map1.keys();\n    return {\n      next: () => {\n        while (true) {\n          const k1 = keys.next();\n          if (k1.done) return { value: undefined, done: true };\n          const n = this._map1.get(k1.value);\n          if (typeof n === \"undefined\") continue;\n          const v1 = this._map3.get(n);\n          const v2 = this._map4.get(n);\n          if (!v1) continue;\n          const k2 = this._get2(n);\n          return { value: [k1.value, v1, k2, v2], done: false };\n        }\n      },\n    };\n  }\n\n  _get2(num: number) {\n    for (const [k, v] of this._map2) {\n      if (v === num) return k;\n    }\n  }\n\n  _call(\n    fn: QuickJSHandle,\n    thisArg: QuickJSHandle | undefined,\n    ...args: QuickJSHandle[]\n  ) {\n    return this.vm.unwrapResult(\n      this.vm.callFunction(\n        fn,\n        typeof thisArg === \"undefined\" ? this.vm.undefined : thisArg,\n        ...args\n      )\n    );\n  }\n}\n","export function isES2015Class(cls: any): cls is new (...args: any[]) => any {\n  return (\n    typeof cls === \"function\" &&\n    /^class\\s/.test(Function.prototype.toString.call(cls))\n  );\n}\n\nexport function isObject(value: any): value is object | Function {\n  return (\n    typeof value === \"function\" || (typeof value === \"object\" && value !== null)\n  );\n}\n\nexport function walkObject(\n  value: any,\n  callback?: (target: any, set: Set<any>) => boolean | void\n): Set<any> {\n  const set = new Set<any>();\n  const walk = (v: any) => {\n    if (!isObject(v) || set.has(v) || callback?.(v, set) === false) return;\n    set.add(v);\n\n    if (Array.isArray(v)) {\n      for (const e of v) {\n        walk(e);\n      }\n      return;\n    }\n\n    if (typeof v === \"object\") {\n      const proto = Object.getPrototypeOf(v);\n      if (proto && proto !== Object.prototype) {\n        walk(proto);\n      }\n    }\n\n    for (const d of Object.values(Object.getOwnPropertyDescriptors(v))) {\n      if (\"value\" in d) walk(d.value);\n      if (\"get\" in d) walk(d.get);\n      if (\"set\" in d) walk(d.set);\n    }\n  };\n\n  walk(value);\n  return set;\n}\n\n/**\n * Measure the complexity of an object as you traverse the field and prototype chain. If max is specified, when the complexity reaches max, the traversal is terminated and it returns the max. In this function, one object and function are counted as a complexity of 1, and primitives are not counted as a complexity.\n */\nexport function complexity(value: any, max?: number): number {\n  return walkObject(value, max ? (_, set) => set.size < max : undefined).size;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport function call(\n  vm: QuickJSVm,\n  code: string,\n  thisArg?: QuickJSHandle,\n  ...args: QuickJSHandle[]\n): QuickJSHandle {\n  return vm.unwrapResult(vm.evalCode(code)).consume((f) => {\n    if (typeof thisArg === \"undefined\" && args.length === 0) return f;\n    return vm.unwrapResult(\n      vm.callFunction(f, thisArg ?? vm.undefined, ...args)\n    );\n  });\n}\n\nexport function eq(vm: QuickJSVm, a: QuickJSHandle, b: QuickJSHandle): boolean {\n  return vm.dump(call(vm, \"Object.is\", undefined, a, b));\n}\n\nexport function instanceOf(\n  vm: QuickJSVm,\n  a: QuickJSHandle,\n  b: QuickJSHandle\n): boolean {\n  return vm.dump(call(vm, \"(a, b) => a instanceof b\", undefined, a, b));\n}\n\nexport function isHandleObject(vm: QuickJSVm, a: QuickJSHandle): boolean {\n  return vm.dump(\n    call(\n      vm,\n      `a => typeof a === \"object\" && a !== null || typeof a === \"function\"`,\n      undefined,\n      a\n    )\n  );\n}\n\nexport function send(vm: QuickJSVm, target: any): QuickJSHandle {\n  const json = JSON.stringify(target);\n  if (!json) return vm.undefined;\n  return call(vm, `JSON.parse`, undefined, vm.newString(json));\n}\n\nexport function consumeAll<T extends QuickJSHandle[], K>(\n  handles: T,\n  cb: (handles: T) => K\n): K {\n  try {\n    return cb(handles);\n  } finally {\n    for (const h of handles) {\n      if (h.alive) h.dispose();\n    }\n  }\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\n\nexport default function marshalProperties(\n  vm: QuickJSVm,\n  target: object | Function,\n  handle: QuickJSHandle,\n  marshal: (target: unknown) => QuickJSHandle\n): void {\n  const descs = vm.newObject();\n  const cb = (key: string | number | symbol, desc: PropertyDescriptor) => {\n    const keyHandle = marshal(key);\n    const valueHandle =\n      typeof desc.value === \"undefined\" ? undefined : marshal(desc.value);\n    const getHandle =\n      typeof desc.get === \"undefined\" ? undefined : marshal(desc.get);\n    const setHandle =\n      typeof desc.set === \"undefined\" ? undefined : marshal(desc.set);\n\n    vm.newObject().consume((descObj) => {\n      Object.entries(desc).forEach(([k, v]) => {\n        const v2 =\n          k === \"value\"\n            ? valueHandle\n            : k === \"get\"\n            ? getHandle\n            : k === \"set\"\n            ? setHandle\n            : v\n            ? vm.true\n            : vm.false;\n        if (v2) {\n          vm.setProp(descObj, k, v2);\n        }\n      });\n      vm.setProp(descs, keyHandle, descObj);\n    });\n  };\n\n  const desc = Object.getOwnPropertyDescriptors(target);\n  Object.entries(desc).forEach(([k, v]) => cb(k, v));\n  Object.getOwnPropertySymbols(desc).forEach((k) => cb(k, (desc as any)[k]));\n\n  call(vm, `Object.defineProperties`, undefined, handle, descs).dispose();\n\n  descs.dispose();\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { isES2015Class, isObject } from \"../util\";\nimport { call } from \"../vmutil\";\nimport marshalProperties from \"./properties\";\n\nexport default function marshalFunction(\n  vm: QuickJSVm,\n  target: unknown,\n  marshal: (target: unknown) => QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => unknown,\n  preMarshal: (\n    target: unknown,\n    handle: QuickJSHandle\n  ) => QuickJSHandle | undefined,\n  preApply?: (target: Function, thisArg: unknown, args: unknown[]) => any\n): QuickJSHandle | undefined {\n  if (typeof target !== \"function\") return;\n\n  const raw = vm\n    .newFunction(target.name, function (...argHandles) {\n      const that = unmarshal(this);\n      const args = argHandles.map((a) => unmarshal(a));\n\n      if (isES2015Class(target) && isObject(that)) {\n        // Class constructors cannot be invoked without new expression, and new.target is not changed\n        const result = new target(...args);\n        Object.entries(result).forEach(([key, value]) => {\n          vm.setProp(this, key, marshal(value));\n        });\n        return this;\n      }\n\n      return marshal(\n        preApply ? preApply(target, that, args) : target.apply(that, args)\n      );\n    })\n    .consume((handle2) =>\n      // fucntions created by vm.newFunction are not callable as a class constrcutor\n      call(\n        vm,\n        `Cls => {\n          const fn = function(...args) { return Cls.apply(this, args); };\n          fn.name = Cls.name;\n          fn.length = Cls.length;\n          return fn;\n        }`,\n        undefined,\n        handle2\n      )\n    );\n\n  const handle = preMarshal(target, raw) ?? raw;\n  marshalProperties(vm, target, raw, marshal);\n\n  return handle;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\nimport marshalProperties from \"./properties\";\n\nexport default function marshalObject(\n  vm: QuickJSVm,\n  target: unknown,\n  marshal: (target: unknown) => QuickJSHandle,\n  preMarshal: (\n    target: unknown,\n    handle: QuickJSHandle\n  ) => QuickJSHandle | undefined\n): QuickJSHandle | undefined {\n  if (typeof target !== \"object\" || target === null) return;\n\n  const raw = Array.isArray(target) ? vm.newArray() : vm.newObject();\n  const handle = preMarshal(target, raw) ?? raw;\n\n  // prototype\n  const prototype = Object.getPrototypeOf(target);\n  const prototypeHandle =\n    prototype && prototype !== Object.prototype && prototype !== Array.prototype\n      ? marshal(prototype)\n      : undefined;\n  if (prototypeHandle) {\n    call(\n      vm,\n      \"Object.setPrototypeOf\",\n      undefined,\n      handle,\n      prototypeHandle\n    ).dispose();\n  }\n\n  marshalProperties(vm, target, raw, marshal);\n\n  return handle;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n// import { call } from \"../vmutil\";\n\nexport default function marshalPrimitive(\n  vm: QuickJSVm,\n  target: unknown\n): QuickJSHandle | undefined {\n  switch (typeof target) {\n    case \"undefined\":\n      return vm.undefined;\n    case \"number\":\n      return vm.newNumber(target);\n    case \"string\":\n      return vm.newString(target);\n    case \"boolean\":\n      return target ? vm.true : vm.false;\n    case \"object\":\n      return target === null ? vm.null : undefined;\n\n    // BigInt is not supported by quickjs-emscripten\n    // case \"bigint\":\n    //   return call(\n    //     vm,\n    //     `s => BigInt(s)`,\n    //     undefined,\n    //     vm.newString(target.toString())\n    //   );\n  }\n\n  return undefined;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\n\nexport default function marshalSymbol(\n  vm: QuickJSVm,\n  target: unknown,\n  preMarshal: (\n    target: unknown,\n    handle: QuickJSHandle\n  ) => QuickJSHandle | undefined\n): QuickJSHandle | undefined {\n  if (typeof target !== \"symbol\") return;\n  const handle = call(\n    vm,\n    \"d => Symbol(d)\",\n    undefined,\n    target.description ? vm.newString(target.description) : vm.undefined\n  );\n  return preMarshal(target, handle) ?? handle;\n}\n","import { QuickJSHandle, QuickJSVm } from \"quickjs-emscripten\";\nimport marshalFunction from \"./function\";\nimport marshalObject from \"./object\";\nimport marshalPrimitive from \"./primitive\";\nimport marshalSymbol from \"./symbol\";\n\nexport type Options = {\n  vm: QuickJSVm;\n  unmarshal: (handle: QuickJSHandle) => unknown;\n  isMarshalable?: (target: unknown) => boolean;\n  find: (target: unknown) => QuickJSHandle | undefined;\n  pre: (target: unknown, handle: QuickJSHandle) => QuickJSHandle | undefined;\n  preApply?: (target: Function, thisArg: unknown, args: unknown[]) => any;\n};\n\nexport function marshal(target: unknown, options: Options): QuickJSHandle {\n  const { vm, unmarshal, isMarshalable, find, pre } = options;\n\n  {\n    const primitive = marshalPrimitive(vm, target);\n    if (primitive) {\n      return primitive;\n    }\n  }\n\n  {\n    const handle = find(target);\n    if (handle) return handle;\n  }\n\n  if (isMarshalable?.(target) === false) {\n    return vm.undefined;\n  }\n\n  const marshal2 = (t: unknown) => marshal(t, options);\n\n  const result =\n    marshalSymbol(vm, target, pre) ??\n    marshalFunction(vm, target, marshal2, unmarshal, pre, options.preApply) ??\n    marshalObject(vm, target, marshal2, pre) ??\n    vm.undefined;\n\n  return result;\n}\n\nexport default marshal;\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\n\nexport default function unmarshalProperties(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  target: object | Function,\n  unmarshal: (handle: QuickJSHandle) => [unknown, boolean]\n) {\n  vm.newFunction(\"\", (key, value) => {\n    const [keyName] = unmarshal(key);\n    if (\n      typeof keyName !== \"string\" &&\n      typeof keyName !== \"number\" &&\n      typeof keyName !== \"symbol\"\n    )\n      return;\n\n    const desc = (\n      [\n        [\"value\", true],\n        [\"get\", true],\n        [\"set\", true],\n        [\"configurable\", false],\n        [\"enumerable\", false],\n        [\"writable\", false],\n      ] as const\n    ).reduce<PropertyDescriptor>((desc, [key, unmarshable]) => {\n      const h = vm.getProp(value, key);\n      const ty = vm.typeof(h);\n\n      if (ty === \"undefined\") return desc;\n      if (!unmarshable && ty === \"boolean\") {\n        desc[key] = vm.dump(vm.getProp(value, key));\n        return desc;\n      }\n\n      const [v, alreadyExists] = unmarshal(h);\n      if (alreadyExists) {\n        h.dispose();\n      }\n      desc[key] = v;\n\n      return desc;\n    }, {});\n\n    Object.defineProperty(target, keyName, desc);\n  }).consume((fn) => {\n    call(\n      vm,\n      `(o, fn) => {\n        const descs = Object.getOwnPropertyDescriptors(o);\n        Object.entries(descs).forEach(([k, v]) => fn(k, v));\n        Object.getOwnPropertySymbols(descs).forEach(k => fn(k, descs[k]));\n      }`,\n      undefined,\n      handle,\n      fn\n    ).dispose();\n  });\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\nimport unmarshalProperties from \"./properties\";\n\nexport default function unmarshalFunction(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  marshal: (value: unknown) => QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => [unknown, boolean],\n  preUnmarshal: <T>(target: T, handle: QuickJSHandle) => T | undefined\n): Function | undefined {\n  if (vm.typeof(handle) !== \"function\") return;\n\n  const raw = function (this: any, ...args: any[]) {\n    const thisHandle = marshal(this);\n    const argHandles = args.map((a) => marshal(a));\n\n    if (new.target) {\n      const [instance] = unmarshal(\n        call(\n          vm,\n          `(Cls, ...args) => new Cls(...args)`,\n          thisHandle,\n          handle,\n          ...argHandles\n        )\n      );\n      Object.defineProperties(this, Object.getOwnPropertyDescriptors(instance));\n      return this;\n    }\n\n    const resultHandle = vm.unwrapResult(\n      vm.callFunction(handle, thisHandle, ...argHandles)\n    );\n    const [result, alreadyExists] = unmarshal(resultHandle);\n    if (alreadyExists) resultHandle.dispose();\n    return result;\n  };\n\n  const func = preUnmarshal(raw, handle) ?? raw;\n  unmarshalProperties(vm, handle, raw, unmarshal);\n\n  return func;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport unmarshalProperties from \"./properties\";\nimport { call } from \"../vmutil\";\n\nexport default function unmarshalObject(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => [unknown, boolean],\n  preUnmarshal: <T>(target: T, handle: QuickJSHandle) => T | undefined\n): object | undefined {\n  if (\n    vm.typeof(handle) !== \"object\" ||\n    // null check\n    vm\n      .unwrapResult(vm.evalCode(\"o => o === null\"))\n      .consume((n) =>\n        vm.dump(vm.unwrapResult(vm.callFunction(n, vm.undefined, handle)))\n      )\n  )\n    return;\n\n  const raw = call(vm, \"Array.isArray\", undefined, handle).consume((r) =>\n    vm.dump(r)\n  )\n    ? []\n    : {};\n  const obj = preUnmarshal(raw, handle) ?? raw;\n\n  const prototype = call(\n    vm,\n    `o => {\n      const p = Object.getPrototypeOf(o);\n      return !p || p === Object.prototype || p === Array.prototype ? undefined : p;\n    }`,\n    undefined,\n    handle\n  ).consume((prototype) => {\n    if (vm.typeof(prototype) === \"undefined\") return;\n    const [proto] = unmarshal(prototype);\n    return proto;\n  });\n  if (typeof prototype === \"object\") {\n    Object.setPrototypeOf(obj, prototype);\n  }\n\n  unmarshalProperties(vm, handle, raw, unmarshal);\n\n  return obj;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport default function unmarshalPrimitive(\n  vm: QuickJSVm,\n  handle: QuickJSHandle\n): [any, boolean] {\n  const ty = vm.typeof(handle);\n  if (\n    ty === \"undefined\" ||\n    ty === \"number\" ||\n    ty === \"string\" ||\n    ty === \"boolean\"\n  ) {\n    return [vm.dump(handle), true];\n  } else if (ty === \"object\") {\n    const isNull = vm\n      .unwrapResult(vm.evalCode(\"a => a === null\"))\n      .consume((n) =>\n        vm.dump(vm.unwrapResult(vm.callFunction(n, vm.undefined, handle)))\n      );\n    if (isNull) {\n      return [null, true];\n    }\n  }\n\n  // BigInt is not supported by quickjs-emscripten\n  // if (ty === \"bigint\") {\n  //   const str = vm\n  //     .getProp(handle, \"toString\")\n  //     .consume(toString => vm.unwrapResult(vm.callFunction(toString, handle)))\n  //     .consume(str => vm.getString(str));\n  //   const bi = BigInt(str);\n  //   return [bi, true];\n  // }\n\n  return [undefined, false];\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport default function unmarshalSymbol(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  preUnmarshal: <T>(target: T, handle: QuickJSHandle) => T | undefined\n): symbol | undefined {\n  if (vm.typeof(handle) !== \"symbol\") return;\n  const desc = vm.getString(vm.getProp(handle, \"description\"));\n  const sym = Symbol(desc);\n  return preUnmarshal(sym, handle) ?? sym;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport unmarshalFunction from \"./function\";\nimport unmarshalObject from \"./object\";\nimport unmarshalPrimitive from \"./primitive\";\nimport unmarshalSymbol from \"./symbol\";\n\nexport type Options = {\n  vm: QuickJSVm;\n  marshal: (target: unknown) => QuickJSHandle;\n  find: (handle: QuickJSHandle) => unknown | undefined;\n  pre: <T>(target: T, handle: QuickJSHandle) => T | undefined;\n};\n\nexport function unmarshal(handle: QuickJSHandle, options: Options): any {\n  const [result] = unmarshalInner(handle, options);\n  return result;\n}\n\nfunction unmarshalInner(\n  handle: QuickJSHandle,\n  options: Options\n): [any, boolean] {\n  const { vm, marshal, find, pre } = options;\n\n  {\n    const [target, ok] = unmarshalPrimitive(vm, handle);\n    if (ok) return [target, false];\n  }\n\n  {\n    const target = find(handle);\n    if (target) {\n      return [target, true];\n    }\n  }\n\n  const unmarshal2 = (h: QuickJSHandle) => unmarshalInner(h, options);\n\n  const result =\n    unmarshalSymbol(vm, handle, pre) ??\n    unmarshalFunction(vm, handle, marshal, unmarshal2, pre) ??\n    unmarshalObject(vm, handle, unmarshal2, pre);\n\n  return [result, false];\n}\n\nexport default unmarshal;\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { isObject } from \"./util\";\nimport { call, isHandleObject, consumeAll } from \"./vmutil\";\n\nexport type SyncMode = \"both\" | \"vm\" | \"host\";\n\nexport type Wrapped<T> = T & { __qes_wrapped: never };\n\nexport function wrap<T = any>(\n  vm: QuickJSVm,\n  target: T,\n  proxyKeySymbol: symbol,\n  proxyKeySymbolHandle: QuickJSHandle,\n  marshal: (target: any) => QuickJSHandle,\n  syncMode?: (target: T) => SyncMode | undefined\n): Wrapped<T> | undefined {\n  if (!isObject(target)) return undefined;\n  if (isWrapped(target, proxyKeySymbol)) return target;\n\n  const rec = new Proxy(target as any, {\n    get(obj, key) {\n      return key === proxyKeySymbol ? obj : Reflect.get(obj, key);\n    },\n    set(obj, key, value, receiver) {\n      const v = unwrap(value, proxyKeySymbol);\n      const sync = syncMode?.(receiver) ?? \"host\";\n      if (sync === \"vm\" || Reflect.set(obj, key, v, receiver)) {\n        if (sync === \"host\") return true;\n        const [handle2, unwrapped] = unwrapHandle(\n          vm,\n          marshal(receiver),\n          proxyKeySymbolHandle\n        );\n        if (unwrapped) {\n          handle2.consume((h) => vm.setProp(h, marshal(key), marshal(v)));\n        } else {\n          vm.setProp(handle2, marshal(key), marshal(v));\n        }\n      }\n      return true;\n    },\n    deleteProperty(obj, key) {\n      const sync = syncMode?.(rec) ?? \"host\";\n      const [handle2, unwrapped] = unwrapHandle(\n        vm,\n        marshal(rec),\n        proxyKeySymbolHandle\n      );\n      if (sync === \"vm\" || Reflect.deleteProperty(obj, key)) {\n        if (sync === \"host\") return true;\n        if (unwrapped) {\n          handle2.consume((h) =>\n            call(vm, `(a, b) => delete a[b]`, undefined, h, marshal(key))\n          );\n        } else {\n          call(vm, `(a, b) => delete a[b]`, undefined, handle2, marshal(key));\n        }\n      }\n      return true;\n    },\n  }) as Wrapped<T>;\n  return rec;\n}\n\nexport function wrapHandle(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  proxyKeySymbol: symbol,\n  proxyKeySymbolHandle: QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => any,\n  syncMode?: (target: QuickJSHandle) => SyncMode | undefined\n): [Wrapped<QuickJSHandle> | undefined, boolean] {\n  if (!isHandleObject(vm, handle)) return [undefined, false];\n  if (isHandleWrapped(vm, handle, proxyKeySymbolHandle)) return [handle, false];\n\n  return consumeAll(\n    [\n      vm.newFunction(\"getSyncMode\", (h) => {\n        const res = syncMode?.(unmarshal(h));\n        if (typeof res === \"string\") return vm.newString(res);\n        return vm.undefined;\n      }),\n      vm.newFunction(\"setter\", (h, keyHandle, valueHandle) => {\n        const target = unmarshal(h);\n        if (!target) return;\n        const key = unmarshal(keyHandle);\n        if (key === \"__proto__\") return; // for security\n        const value = unmarshal(valueHandle);\n        unwrap(target, proxyKeySymbol)[key] = value;\n      }),\n      vm.newFunction(\"deleter\", (h, keyHandle) => {\n        const target = unmarshal(h);\n        if (!target) return;\n        const key = unmarshal(keyHandle);\n        delete unwrap(target, proxyKeySymbol)[key];\n      }),\n    ],\n    (args) => [\n      call(\n        vm,\n        `(target, sym, getSyncMode, setter, deleter) => {\n          const rec =  new Proxy(target, {\n            get(obj, key, receiver) {\n              return key === sym ? obj : Reflect.get(obj, key, receiver)\n            },\n            set(obj, key, value, receiver) {\n              const v = typeof value === \"object\" && value !== null || typeof value === \"function\"\n                ? value[sym] ?? value\n                : value;\n              const sync = getSyncMode(receiver) ?? \"vm\";\n              if (sync === \"host\" || Reflect.set(obj, key, v, receiver)) {\n                if (sync !== \"vm\") {\n                  setter(receiver, key, v);\n                }\n              }\n              return true;\n            },\n            deleteProperty(obj, key) {\n              const sync = getSyncMode(rec) ?? \"vm\";\n              if (sync === \"host\" || Reflect.deleteProperty(obj, key)) {\n                if (sync !== \"vm\") {\n                  deleter(rec, key);\n                }\n              }\n              return true;\n            },\n          });\n          return rec;\n        }`,\n        undefined,\n        handle,\n        proxyKeySymbolHandle,\n        ...args\n      ) as Wrapped<QuickJSHandle>,\n      true,\n    ]\n  );\n}\n\nexport function unwrap<T>(obj: T, key: string | symbol): T {\n  return isObject(obj) ? ((obj as any)[key] as T) ?? obj : obj;\n}\n\nexport function unwrapHandle(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  key: QuickJSHandle\n): [QuickJSHandle, boolean] {\n  if (!isHandleWrapped(vm, handle, key)) return [handle, false];\n  return [vm.getProp(handle, key), true];\n}\n\nexport function isWrapped<T>(obj: T, key: string | symbol): obj is Wrapped<T> {\n  return isObject(obj) && !!(obj as any)[key];\n}\n\nexport function isHandleWrapped(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  key: QuickJSHandle\n): handle is Wrapped<QuickJSHandle> {\n  return !!vm.dump(\n    call(\n      vm,\n      `(a, s) => (typeof a === \"object\" && a !== null || typeof a === \"function\") && !!a[s]`,\n      undefined,\n      handle,\n      key\n    )\n  );\n}\n","/**\n * Default value of registeredObjects option of the Arena class constructor.\n */\nexport const defaultRegisteredObjects: [any, string][] = [\n  // basic objects\n  [Symbol, \"Symbol\"],\n  [Symbol.prototype, \"Symbol.prototype\"],\n  [Object, \"Object\"],\n  [Object.prototype, \"Object.prototype\"],\n  [Function, \"Function\"],\n  [Function.prototype, \"Function.prototype\"],\n  [Boolean, \"Boolean\"],\n  [Boolean.prototype, \"Boolean.prototype\"],\n  [Array, \"Array\"],\n  [Array.prototype, \"Array.prototype\"],\n  // [BigInt, \"BigInt\"],\n  // [BigInt.prototype, \"BigInt.prototype\"],\n  // errors\n  [Error, \"Error\"],\n  [Error.prototype, \"Error.prototype\"],\n  [EvalError, \"EvalError\"],\n  [EvalError.prototype, \"EvalError.prototype\"],\n  [RangeError, \"RangeError\"],\n  [RangeError.prototype, \"RangeError.prototype\"],\n  [ReferenceError, \"ReferenceError\"],\n  [ReferenceError.prototype, \"ReferenceError.prototype\"],\n  [SyntaxError, \"SyntaxError\"],\n  [SyntaxError.prototype, \"SyntaxError.prototype\"],\n  [TypeError, \"TypeError\"],\n  [TypeError.prototype, \"TypeError.prototype\"],\n  [URIError, \"URIError\"],\n  [URIError.prototype, \"URIError.prototype\"],\n  // built-in symbols\n  ...Object.getOwnPropertyNames(Symbol)\n    .filter((k) => typeof (Symbol as any)[k] === \"symbol\")\n    .map<[any, string]>((k) => [(Symbol as any)[k], `Symbol.${k}`]),\n];\n","import { QuickJSHandle, QuickJSVm } from \"quickjs-emscripten\";\nimport {\n  SuccessOrFail,\n  VmCallResult,\n} from \"quickjs-emscripten/dist/vm-interface\";\n\nimport VMMap from \"./vmmap\";\nimport marshal from \"./marshal\";\nimport unmarshal from \"./unmarshal\";\nimport { wrap, wrapHandle, unwrap, unwrapHandle, Wrapped } from \"./wrapper\";\nimport { complexity, isES2015Class, isObject, walkObject } from \"./util\";\nimport { call, eq, isHandleObject, send, consumeAll } from \"./vmutil\";\nimport { defaultRegisteredObjects } from \"./default\";\n\nexport {\n  VMMap,\n  defaultRegisteredObjects,\n  marshal,\n  unmarshal,\n  complexity,\n  isES2015Class,\n  isObject,\n  walkObject,\n  call,\n  eq,\n  isHandleObject,\n  send,\n  consumeAll,\n};\n\nexport type Options = {\n  /** A callback that returns a boolean value that determines whether an object is marshalled or not. If false, no marshaling will be done and undefined will be passed to the QuickJS VM, otherwise marshaling will be done. By default, all objects will be marshalled. */\n  isMarshalable?: (target: any) => boolean;\n  /** You can pre-register a pair of objects that will be considered the same between the host and the QuickJS VM. This will be used automatically during the conversion. By default, it will be registered automatically with `defaultRegisteredObjects`.\n   *\n   * Instead of a string, you can also pass a QuickJSHandle directly. In that case, however, you have to dispose of them manually when destroying the VM.\n   */\n  registeredObjects?: Iterable<[any, QuickJSHandle | string]>;\n};\n\n/**\n * The Arena class manages all generated handles at once by quickjs-emscripten and automatically converts objects between the host and the QuickJS VM.\n */\nexport class Arena {\n  vm: QuickJSVm;\n  _map: VMMap;\n  _registeredMap: VMMap;\n  _registeredMapDispose: Set<any> = new Set();\n  _sync: Set<any> = new Set();\n  _temporalSync: Set<any> = new Set();\n  _symbol = Symbol();\n  _symbolHandle: QuickJSHandle;\n  _options?: Options;\n\n  /** Constructs a new Arena instance. It requires a quickjs-emscripten VM initialized with `quickjs.createVM()`. */\n  constructor(vm: QuickJSVm, options?: Options) {\n    this.vm = vm;\n    this._options = options;\n    this._symbolHandle = vm.unwrapResult(vm.evalCode(`Symbol()`));\n    this._map = new VMMap(vm);\n    this._registeredMap = new VMMap(vm);\n    this.registerAll(options?.registeredObjects ?? defaultRegisteredObjects);\n  }\n\n  /**\n   * Dispose of the arena and managed handles. This method won't dispose the VM itself, so the VM has to be disposed of manually.\n   */\n  dispose() {\n    this._map.dispose();\n    this._registeredMap.dispose();\n    this._symbolHandle.dispose();\n  }\n\n  /**\n   * Evaluate JS code in the VM and get the result as an object on the host side. It also converts and re-throws error objects when an error is thrown during evaluation.\n   */\n  evalCode<T = any>(code: string): T {\n    const handle = this.vm.evalCode(code);\n    return this._unwrapResultAndUnmarshal(handle);\n  }\n\n  /**\n   * Almost same as `vm.executePendingJobs()`, but it converts and re-throws error objects when an error is thrown during evaluation.\n   */\n  executePendingJobs(maxJobsToExecute?: number): number {\n    const result = this.vm.executePendingJobs(maxJobsToExecute);\n    if (\"value\" in result) {\n      return result.value;\n    }\n    throw result.error.consume((err) => this._unmarshal(err));\n  }\n\n  /**\n   * Expose objects as global objects in the VM.\n   *\n   * By default, exposed objects are not synchronized between the host and the VM.\n   * If you want to sync an objects, first wrap the object with sync method, and then expose the wrapped object.\n   */\n  expose(obj: { [k: string]: any }) {\n    for (const [key, value] of Object.entries(obj)) {\n      const handle = this._marshal(value);\n      this.vm.setProp(this.vm.global, key, handle);\n    }\n  }\n\n  /**\n   * Enables sync for the object between the host and the VM and returns objects wrapped with proxies.\n   *\n   * The return value is necessary in order to reflect changes to the object from the host to the VM. Please note that setting a value in the field or deleting a field in the original object will not synchronize it.\n   */\n  sync<T>(target: T): T {\n    const wrapped = this._wrap(target);\n    if (typeof wrapped === \"undefined\") return target;\n    walkObject(wrapped, (v) => {\n      this._sync.add(this._unwrap(v));\n    });\n    return wrapped;\n  }\n\n  /**\n   * Register a pair of objects that will be considered the same between the host and the QuickJS VM.\n   *\n   * Instead of a string, you can also pass a QuickJSHandle directly. In that case, however, when  you have to dispose them manually when destroying the VM.\n   */\n  register(target: any, handleOrCode: QuickJSHandle | string) {\n    if (this._registeredMap.has(target)) return;\n    const handle =\n      typeof handleOrCode === \"string\"\n        ? this._unwrapResult(this.vm.evalCode(handleOrCode))\n        : handleOrCode;\n    if (eq(this.vm, handle, this.vm.undefined)) return;\n    if (typeof handleOrCode === \"string\") {\n      this._registeredMapDispose.add(target);\n    }\n    this._registeredMap.set(target, handle);\n  }\n\n  /**\n   * Execute `register` methods for each pair.\n   */\n  registerAll(map: Iterable<[any, QuickJSHandle | string]>) {\n    for (const [k, v] of map) {\n      this.register(k, v);\n    }\n  }\n\n  /**\n   * Unregister a pair of objects that were registered with `registeredObjects` option and `register` method.\n   */\n  unregister(target: any, dispose?: boolean) {\n    this._registeredMap.delete(\n      target,\n      this._registeredMapDispose.has(target) || dispose\n    );\n    this._registeredMapDispose.delete(target);\n  }\n\n  /**\n   * Execute `unregister` methods for each target.\n   */\n  unregisterAll(targets: Iterable<any>, dispose?: boolean) {\n    for (const t of targets) {\n      this.unregister(t, dispose);\n    }\n  }\n\n  startSync(target: any) {\n    if (!isObject(target)) return;\n    this._sync.add(this._unwrap(target));\n  }\n\n  endSync(target: any) {\n    this._sync.delete(this._unwrap(target));\n  }\n\n  _unwrapResult<T>(result: SuccessOrFail<T, QuickJSHandle>): T {\n    if (\"value\" in result) {\n      return result.value;\n    }\n    throw result.error.consume((err) => this._unmarshal(err));\n  }\n\n  _unwrapResultAndUnmarshal(\n    result: VmCallResult<QuickJSHandle> | undefined\n  ): any {\n    if (!result) return;\n    return this._unwrapResult(result).consume((h) => this._unmarshal(h));\n  }\n\n  _marshal(target: any): QuickJSHandle {\n    const registered = this._registeredMap.get(target);\n    if (registered) {\n      return registered;\n    }\n\n    const handle = marshal(this._wrap(target) ?? target, {\n      vm: this.vm,\n      unmarshal: (h) => this._unmarshal(h),\n      isMarshalable: (t) =>\n        this._options?.isMarshalable?.(this._unwrap(t)) ?? true,\n      find: (t) => this._registeredMap.get(t) ?? this._map.get(t),\n      pre: (t, h) => this._register(t, h, this._map)?.[1],\n      preApply: (target, that, args) => {\n        const unwrapped = isObject(that) ? this._unwrap(that) : undefined;\n        // override sync mode of this object while calling the function\n        if (unwrapped) this._temporalSync.add(unwrapped);\n        try {\n          return target.apply(that, args);\n        } finally {\n          // restore sync mode\n          if (unwrapped) this._temporalSync.delete(unwrapped);\n        }\n      },\n    });\n\n    return handle;\n  }\n\n  _unmarshal(handle: QuickJSHandle): any {\n    const registered = this._registeredMap.getByHandle(handle);\n    if (typeof registered !== \"undefined\") {\n      return registered;\n    }\n\n    const [wrappedHandle] = this._wrapHandle(handle);\n    return unmarshal(wrappedHandle ?? handle, {\n      vm: this.vm,\n      marshal: (v: any) => this._marshal(v),\n      find: (h) =>\n        this._registeredMap.getByHandle(h) ?? this._map.getByHandle(h),\n      pre: (t: any, h: QuickJSHandle) =>\n        this._register(t, h, undefined, true)?.[0],\n    });\n  }\n\n  _register(\n    t: any,\n    h: QuickJSHandle,\n    map: VMMap = this._map,\n    sync?: boolean\n  ): [Wrapped<any>, Wrapped<QuickJSHandle>] | undefined {\n    if (this._registeredMap.has(t) || this._registeredMap.hasHandle(h)) {\n      return;\n    }\n\n    const wrappedT = this._wrap(t);\n    const [wrappedH] = this._wrapHandle(h);\n    if (!wrappedT || !wrappedH) return; // t or h is not an object\n\n    const unwrappedT = this._unwrap(t);\n    const [unwrappedH, unwrapped] = this._unwrapHandle(h);\n\n    const res = map.set(wrappedT, wrappedH, unwrappedT, unwrappedH);\n    if (!res) {\n      // already registered\n      if (unwrapped) unwrappedH.dispose();\n      throw new Error(\"already registered\");\n    } else if (sync) {\n      this._sync.add(unwrappedT);\n    }\n\n    return [wrappedT, wrappedH];\n  }\n\n  _syncMode(obj: any) {\n    const obj2 = this._unwrap(obj);\n    return this._sync.has(obj2) || this._temporalSync.has(obj2)\n      ? \"both\"\n      : undefined;\n  }\n\n  _wrap<T>(target: T): Wrapped<T> | undefined {\n    return wrap(\n      this.vm,\n      target,\n      this._symbol,\n      this._symbolHandle,\n      (t) => this._marshal(t),\n      (t) => this._syncMode(t)\n    );\n  }\n\n  _unwrap<T>(target: T): T {\n    return unwrap(target, this._symbol);\n  }\n\n  _wrapHandle(\n    handle: QuickJSHandle\n  ): [Wrapped<QuickJSHandle> | undefined, boolean] {\n    return wrapHandle(\n      this.vm,\n      handle,\n      this._symbol,\n      this._symbolHandle,\n      (h) => this._unmarshal(h),\n      (t) => this._syncMode(t)\n    );\n  }\n\n  _unwrapHandle(target: QuickJSHandle): [QuickJSHandle, boolean] {\n    return unwrapHandle(this.vm, target, this._symbolHandle);\n  }\n}\n"],"names":["Symbol","iterator","VMMap","vm","_map1","Map","_map2","_map3","_map4","_counterMap","_disposables","Set","_mapGet","_mapSet","_mapDelete","_mapClear","_counter","result","unwrapResult","evalCode","consume","fn","_call","undefined","getProp","dispose","add","set","key","handle","key2","handle2","alive","v","get","counter","newNumber","c","merge","iteratable","iter","num","getByHandle","getNumber","has","hasHandle","filter","h","k","deleteByHandle","clear","values","keys","next","k1","done","value","n","v1","v2","k2","_get2","thisArg","callFunction","size","isES2015Class","cls","test","Function","prototype","toString","call","isObject","walkObject","callback","walk","Array","isArray","e","proto","Object","getPrototypeOf","getOwnPropertyDescriptors","d","complexity","max","_","code","args","f","length","eq","a","b","dump","isHandleObject","send","target","json","JSON","stringify","newString","consumeAll","handles","cb","marshalProperties","marshal","descs","newObject","desc","keyHandle","valueHandle","getHandle","setHandle","descObj","entries","forEach","setProp","getOwnPropertySymbols","marshalFunction","unmarshal","preMarshal","preApply","raw","newFunction","name","that","map","apply","marshalObject","newArray","prototypeHandle","marshalPrimitive","marshalSymbol","description","options","isMarshalable","find","pre","primitive","marshal2","t","unmarshalProperties","keyName","reduce","unmarshable","ty","alreadyExists","defineProperty","unmarshalFunction","preUnmarshal","thisHandle","argHandles","instance","defineProperties","resultHandle","func","unmarshalObject","r","obj","setPrototypeOf","unmarshalPrimitive","isNull","unmarshalSymbol","getString","sym","unmarshalInner","ok","unmarshal2","wrap","proxyKeySymbol","proxyKeySymbolHandle","syncMode","isWrapped","rec","Proxy","Reflect","receiver","unwrap","sync","unwrapHandle","unwrapped","deleteProperty","wrapHandle","isHandleWrapped","res","defaultRegisteredObjects","Boolean","Error","EvalError","RangeError","ReferenceError","SyntaxError","TypeError","URIError","getOwnPropertyNames","Arena","_map","_registeredMap","_registeredMapDispose","_sync","_temporalSync","_symbol","_symbolHandle","_options","registerAll","registeredObjects","_unwrapResultAndUnmarshal","executePendingJobs","maxJobsToExecute","error","err","_unmarshal","expose","_marshal","global","wrapped","_wrap","_unwrap","register","handleOrCode","_unwrapResult","unregister","unregisterAll","targets","startSync","endSync","registered","_register","_wrapHandle","wrappedHandle","wrappedT","wrappedH","unwrappedT","_unwrapHandle","unwrappedH","_syncMode","obj2"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;mBAyOGA,MAAM,CAACC;;IAvOWC;AAcnB,iBAAYC,EAAZ;;;SAbAA;SACAC,QAA0B,IAAIC,GAAJ;SAC1BC,QAA0B,IAAID,GAAJ;SAC1BE,QAAoC,IAAIF,GAAJ;SACpCG,QAAoC,IAAIH,GAAJ;SACpCI,cAAgC,IAAIJ,GAAJ;SAChCK,eAAmC,IAAIC,GAAJ;SACnCC;SACAC;SACAC;SACAC;SACAC,WAAW;AAGT,SAAKb,EAAL,GAAUA,EAAV;AAEA,QAAMc,MAAM,GAAGd,EAAE,CACde,YADY,CAEXf,EAAE,CAACgB,QAAH,o0BAFW,EA2BZC,OA3BY,CA2BJ,UAACC,EAAD;AAAA,aAAQ,KAAI,CAACC,KAAL,CAAWD,EAAX,EAAeE,SAAf,CAAR;AAAA,KA3BI,CAAf;AA6BA,SAAKX,OAAL,GAAeT,EAAE,CAACqB,OAAH,CAAWP,MAAX,EAAmB,KAAnB,CAAf;AACA,SAAKJ,OAAL,GAAeV,EAAE,CAACqB,OAAH,CAAWP,MAAX,EAAmB,KAAnB,CAAf;AACA,SAAKH,UAAL,GAAkBX,EAAE,CAACqB,OAAH,CAAWP,MAAX,EAAmB,QAAnB,CAAlB;AACA,SAAKF,SAAL,GAAiBZ,EAAE,CAACqB,OAAH,CAAWP,MAAX,EAAmB,OAAnB,CAAjB;AAEAA,IAAAA,MAAM,CAACQ,OAAP;;AAEA,SAAKf,YAAL,CAAkBgB,GAAlB,CAAsB,KAAKd,OAA3B;;AACA,SAAKF,YAAL,CAAkBgB,GAAlB,CAAsB,KAAKb,OAA3B;;AACA,SAAKH,YAAL,CAAkBgB,GAAlB,CAAsB,KAAKZ,UAA3B;;AACA,SAAKJ,YAAL,CAAkBgB,GAAlB,CAAsB,KAAKX,SAA3B;AACD;;;;SAEDY,MAAA,aACEC,GADF,EAEEC,MAFF,EAGEC,IAHF,EAIEC,OAJF;;;;AAME,QAAI,CAACF,MAAM,CAACG,KAAR,IAAkBD,OAAO,IAAI,CAACA,OAAO,CAACC,KAA1C,EAAkD,OAAO,KAAP;AAElD,QAAMC,CAAC,gBAAG,KAAKC,GAAL,CAASN,GAAT,CAAH,wBAAoB,KAAKM,GAAL,CAASJ,IAAT,CAA3B;;AACA,QAAIG,CAAJ,EAAO;AACL;AACA,aAAOA,CAAC,KAAKJ,MAAN,IAAgBI,CAAC,KAAKF,OAA7B;AACD;;AAED,QAAMI,OAAO,GAAG,KAAKnB,QAAL,EAAhB;;AACA,SAAKZ,KAAL,CAAWuB,GAAX,CAAeC,GAAf,EAAoBO,OAApB;;AACA,SAAK5B,KAAL,CAAWoB,GAAX,CAAeQ,OAAf,EAAwBN,MAAxB;;AACA,SAAKpB,WAAL,CAAiBkB,GAAjB,CAAqBQ,OAArB,EAA8BP,GAA9B;;AACA,QAAIE,IAAJ,EAAU;AACR,WAAKxB,KAAL,CAAWqB,GAAX,CAAeG,IAAf,EAAqBK,OAArB;;AACA,UAAIJ,OAAJ,EAAa;AACX,aAAKvB,KAAL,CAAWmB,GAAX,CAAeQ,OAAf,EAAwBJ,OAAxB;AACD;AACF;;AAED,SAAK5B,EAAL,CAAQiC,SAAR,CAAkBD,OAAlB,EAA2Bf,OAA3B,CAAmC,UAACiB,CAAD;AACjC,MAAA,MAAI,CAACf,KAAL,CACE,MAAI,CAACT,OADP,EAEEU,SAFF,EAGEM,MAHF,EAIEQ,CAJF,EAKEN,OALF,WAKEA,OALF,GAKa,MAAI,CAAC5B,EAAL,CAAQoB,SALrB;AAOD,KARD;AAUA,WAAO,IAAP;AACD;;SAEDe,QAAA,eACEC,UADF;AAQE,QAAI,CAACA,UAAL,EAAiB;;AACjB,yDAAmBA,UAAnB,wCAA+B;AAAA,UAApBC,IAAoB;AAC7B,UAAI,CAACA,IAAL,EAAW;;AACX,UAAIA,IAAI,CAAC,CAAD,CAAR,EAAa;AACX,aAAKb,GAAL,CAASa,IAAI,CAAC,CAAD,CAAb,EAAkBA,IAAI,CAAC,CAAD,CAAtB,EAA2BA,IAAI,CAAC,CAAD,CAA/B,EAAoCA,IAAI,CAAC,CAAD,CAAxC;AACD;AACF;AACF;;SAEDN,MAAA,aAAIN,GAAJ;;;AACE,QAAMa,GAAG,sBAAG,KAAKrC,KAAL,CAAW8B,GAAX,CAAeN,GAAf,CAAH,8BAA0B,KAAKtB,KAAL,CAAW4B,GAAX,CAAeN,GAAf,CAAnC;AACA,QAAMC,MAAM,GAAG,OAAOY,GAAP,KAAe,QAAf,GAA0B,KAAKlC,KAAL,CAAW2B,GAAX,CAAeO,GAAf,CAA1B,GAAgDlB,SAA/D;AAEA,QAAI,CAACM,MAAL,EAAa;;AACb,QAAI,CAACA,MAAM,CAACG,KAAZ,EAAmB;AACjB,qBAAYJ,GAAZ;AACA;AACD;;AAED,WAAOC,MAAP;AACD;;SAEDa,cAAA,qBAAYb,MAAZ;AACE,QAAI,CAACA,MAAM,CAACG,KAAZ,EAAmB;AACjB;AACD;;AACD,WAAO,KAAKvB,WAAL,CAAiByB,GAAjB,CACL,KAAK/B,EAAL,CAAQwC,SAAR,CAAkB,KAAKrB,KAAL,CAAW,KAAKV,OAAhB,EAAyBW,SAAzB,EAAoCM,MAApC,CAAlB,CADK,CAAP;AAGD;;SAEDe,MAAA,aAAIhB,GAAJ;AACE,WAAO,CAAC,CAAC,KAAKM,GAAL,CAASN,GAAT,CAAT;AACD;;SAEDiB,YAAA,mBAAUhB,MAAV;AACE,WAAO,OAAO,KAAKa,WAAL,CAAiBb,MAAjB,CAAP,KAAoC,WAA3C;AACD;;qBAED,iBAAOD,GAAP,EAAiBH,OAAjB;;;AACE,QAAMgB,GAAG,uBAAG,KAAKrC,KAAL,CAAW8B,GAAX,CAAeN,GAAf,CAAH,+BAA0B,KAAKtB,KAAL,CAAW4B,GAAX,CAAeN,GAAf,CAAnC;AACA,QAAI,OAAOa,GAAP,KAAe,WAAnB,EAAgC;;AAEhC,QAAMZ,MAAM,GAAG,KAAKtB,KAAL,CAAW2B,GAAX,CAAeO,GAAf,CAAf;;AACA,QAAMV,OAAO,GAAG,KAAKvB,KAAL,CAAW0B,GAAX,CAAeO,GAAf,CAAhB;;AACA,SAAKnB,KAAL,cACE,KAAKR,UADP,EAEES,SAFF,SAGK,CAACM,MAAD,EAASE,OAAT,EAAkBe,MAAlB,CAAyB,UAACC,CAAD;AAAA,aAA2B,CAAC,EAACA,CAAD,YAACA,CAAC,CAAEf,KAAJ,CAA5B;AAAA,KAAzB,CAHL;;AAMA,SAAK5B,KAAL,WAAkBwB,GAAlB;;AACA,SAAKtB,KAAL,WAAkBsB,GAAlB;;AACA,SAAKrB,KAAL,WAAkBkC,GAAlB;;AACA,SAAKjC,KAAL,WAAkBiC,GAAlB;;AAEA,0DAAqB,KAAKrC,KAA1B,2CAAiC;AAAA;AAAA,UAArB4C,CAAqB;AAAA,UAAlBf,CAAkB;;AAC/B,UAAIA,CAAC,KAAKQ,GAAV,EAAe;AACb,aAAKrC,KAAL,WAAkB4C,CAAlB;;AACA;AACD;AACF;;AAED,0DAAqB,KAAK1C,KAA1B,2CAAiC;AAAA;AAAA,UAArB0C,EAAqB;AAAA,UAAlBf,EAAkB;;AAC/B,UAAIA,EAAC,KAAKQ,GAAV,EAAe;AACb,aAAKnC,KAAL,WAAkB0C,EAAlB;;AACA;AACD;AACF;;AAED,0DAAqB,KAAKvC,WAA1B,2CAAuC;AAAA;AAAA,UAA3BuC,GAA2B;AAAA,UAAxBf,GAAwB;;AACrC,UAAIA,GAAC,KAAKL,GAAV,EAAe;AACb,aAAKnB,WAAL,WAAwBuC,GAAxB;;AACA;AACD;AACF;;AAED,QAAIvB,OAAJ,EAAa;AACX,UAAII,MAAJ,YAAIA,MAAM,CAAEG,KAAZ,EAAmBH,MAAM,CAACJ,OAAP;AACnB,UAAIM,OAAJ,YAAIA,OAAO,CAAEC,KAAb,EAAoBD,OAAO,CAACN,OAAR;AACrB;AACF;;SAEDwB,iBAAA,wBAAepB,MAAf,EAAsCJ,OAAtC;AACE,QAAMG,GAAG,GAAG,KAAKc,WAAL,CAAiBb,MAAjB,CAAZ;;AACA,QAAI,OAAOD,GAAP,KAAe,WAAnB,EAAgC;AAC9B,qBAAYA,GAAZ,EAAiBH,OAAjB;AACD;AACF;;SAEDyB,QAAA;AACE,SAAKlC,QAAL,GAAgB,CAAhB;;AACA,SAAKZ,KAAL,CAAW8C,KAAX;;AACA,SAAK5C,KAAL,CAAW4C,KAAX;;AACA,SAAK3C,KAAL,CAAW2C,KAAX;;AACA,SAAK1C,KAAL,CAAW0C,KAAX;;AACA,SAAKzC,WAAL,CAAiByC,KAAjB;;AACA,QAAI,KAAKnC,SAAL,CAAeiB,KAAnB,EAA0B;AACxB,WAAKV,KAAL,CAAW,KAAKP,SAAhB,EAA2BQ,SAA3B;AACD;AACF;;SAEDE,UAAA;AACE,0DAAgB,KAAKf,YAAL,CAAkByC,MAAlB,EAAhB,2CAA4C;AAAA,UAAjClB,CAAiC;;AAC1C,UAAIA,CAAC,CAACD,KAAN,EAAa;AACXC,QAAAA,CAAC,CAACR,OAAF;AACD;AACF;;AACD,0DAAgB,KAAKlB,KAAL,CAAW4C,MAAX,EAAhB,2CAAqC;AAAA,UAA1BlB,GAA0B;;AACnC,UAAIA,GAAC,CAACD,KAAN,EAAa;AACXC,QAAAA,GAAC,CAACR,OAAF;AACD;AACF;;AACD,0DAAgB,KAAKjB,KAAL,CAAW2C,MAAX,EAAhB,2CAAqC;AAAA,UAA1BlB,GAA0B;;AACnC,UAAIA,GAAC,CAACD,KAAN,EAAa;AACXC,QAAAA,GAAC,CAACR,OAAF;AACD;AACF;;AACD,SAAKf,YAAL,CAAkBwC,KAAlB;;AACA,SAAKA,KAAL;AACD;;8BAMD;;;AAGE,QAAME,IAAI,GAAG,KAAKhD,KAAL,CAAWgD,IAAX,EAAb;;AACA,WAAO;AACLC,MAAAA,IAAI,EAAE;AACJ,eAAO,IAAP,EAAa;AACX,cAAMC,EAAE,GAAGF,IAAI,CAACC,IAAL,EAAX;AACA,cAAIC,EAAE,CAACC,IAAP,EAAa,OAAO;AAAEC,YAAAA,KAAK,EAAEjC,SAAT;AAAoBgC,YAAAA,IAAI,EAAE;AAA1B,WAAP;;AACb,cAAME,CAAC,GAAG,MAAI,CAACrD,KAAL,CAAW8B,GAAX,CAAeoB,EAAE,CAACE,KAAlB,CAAV;;AACA,cAAI,OAAOC,CAAP,KAAa,WAAjB,EAA8B;;AAC9B,cAAMC,EAAE,GAAG,MAAI,CAACnD,KAAL,CAAW2B,GAAX,CAAeuB,CAAf,CAAX;;AACA,cAAME,EAAE,GAAG,MAAI,CAACnD,KAAL,CAAW0B,GAAX,CAAeuB,CAAf,CAAX;;AACA,cAAI,CAACC,EAAL,EAAS;;AACT,cAAME,EAAE,GAAG,MAAI,CAACC,KAAL,CAAWJ,CAAX,CAAX;;AACA,iBAAO;AAAED,YAAAA,KAAK,EAAE,CAACF,EAAE,CAACE,KAAJ,EAAWE,EAAX,EAAeE,EAAf,EAAmBD,EAAnB,CAAT;AAAiCJ,YAAAA,IAAI,EAAE;AAAvC,WAAP;AACD;AACF;AAbI,KAAP;AAeD;;SAEDM,QAAA,eAAMpB,GAAN;AACE,0DAAqB,KAAKnC,KAA1B,2CAAiC;AAAA;AAAA,UAArB0C,CAAqB;AAAA,UAAlBf,CAAkB;AAC/B,UAAIA,CAAC,KAAKQ,GAAV,EAAe,OAAOO,CAAP;AAChB;AACF;;SAED1B,QAAA,eACED,EADF,EAEEyC,OAFF;;;AAKE,WAAO,KAAK3D,EAAL,CAAQe,YAAR,CACL,iBAAKf,EAAL,EAAQ4D,YAAR,kBACE1C,EADF,EAEE,OAAOyC,OAAP,KAAmB,WAAnB,GAAiC,KAAK3D,EAAL,CAAQoB,SAAzC,GAAqDuC,OAFvD,sCADK,CAAP;AAOD;;;;SA3CD;AACE,aAAO,KAAK1D,KAAL,CAAW4D,IAAlB;AACD;;;;;;SCvOaC,cAAcC;AAC5B,SACE,OAAOA,GAAP,KAAe,UAAf,IACA,WAAWC,IAAX,CAAgBC,QAAQ,CAACC,SAAT,CAAmBC,QAAnB,CAA4BC,IAA5B,CAAiCL,GAAjC,CAAhB,CAFF;AAID;SAEeM,SAAShB;AACvB,SACE,OAAOA,KAAP,KAAiB,UAAjB,IAAgC,OAAOA,KAAP,KAAiB,QAAjB,IAA6BA,KAAK,KAAK,IADzE;AAGD;SAEeiB,WACdjB,OACAkB;AAEA,MAAM/C,GAAG,GAAG,IAAIhB,GAAJ,EAAZ;;AACA,MAAMgE,IAAI,GAAG,SAAPA,IAAO,CAAC1C,CAAD;AACX,QAAI,CAACuC,QAAQ,CAACvC,CAAD,CAAT,IAAgBN,GAAG,CAACiB,GAAJ,CAAQX,CAAR,CAAhB,IAA8B,CAAAyC,QAAQ,QAAR,YAAAA,QAAQ,CAAGzC,CAAH,EAAMN,GAAN,CAAR,MAAuB,KAAzD,EAAgE;AAChEA,IAAAA,GAAG,CAACD,GAAJ,CAAQO,CAAR;;AAEA,QAAI2C,KAAK,CAACC,OAAN,CAAc5C,CAAd,CAAJ,EAAsB;AACpB,2DAAgBA,CAAhB,wCAAmB;AAAA,YAAR6C,CAAQ;AACjBH,QAAAA,IAAI,CAACG,CAAD,CAAJ;AACD;;AACD;AACD;;AAED,QAAI,OAAO7C,CAAP,KAAa,QAAjB,EAA2B;AACzB,UAAM8C,KAAK,GAAGC,MAAM,CAACC,cAAP,CAAsBhD,CAAtB,CAAd;;AACA,UAAI8C,KAAK,IAAIA,KAAK,KAAKC,MAAM,CAACX,SAA9B,EAAyC;AACvCM,QAAAA,IAAI,CAACI,KAAD,CAAJ;AACD;AACF;;AAED,sCAAgBC,MAAM,CAAC7B,MAAP,CAAc6B,MAAM,CAACE,yBAAP,CAAiCjD,CAAjC,CAAd,CAAhB,oCAAoE;AAA/D,UAAMkD,CAAC,qBAAP;AACH,UAAI,WAAWA,CAAf,EAAkBR,IAAI,CAACQ,CAAC,CAAC3B,KAAH,CAAJ;AAClB,UAAI,SAAS2B,CAAb,EAAgBR,IAAI,CAACQ,CAAC,CAACjD,GAAH,CAAJ;AAChB,UAAI,SAASiD,CAAb,EAAgBR,IAAI,CAACQ,CAAC,CAACxD,GAAH,CAAJ;AACjB;AACF,GAvBD;;AAyBAgD,EAAAA,IAAI,CAACnB,KAAD,CAAJ;AACA,SAAO7B,GAAP;AACD;AAED;;;;SAGgByD,WAAW5B,OAAY6B;AACrC,SAAOZ,UAAU,CAACjB,KAAD,EAAQ6B,GAAG,GAAG,UAACC,CAAD,EAAI3D,GAAJ;AAAA,WAAYA,GAAG,CAACqC,IAAJ,GAAWqB,GAAvB;AAAA,GAAH,GAAgC9D,SAA3C,CAAV,CAAgEyC,IAAvE;AACD;;SClDeO,KACdpE,IACAoF,MACAzB;MACG0B;AAEH,SAAOrF,EAAE,CAACe,YAAH,CAAgBf,EAAE,CAACgB,QAAH,CAAYoE,IAAZ,CAAhB,EAAmCnE,OAAnC,CAA2C,UAACqE,CAAD;AAChD,QAAI,OAAO3B,OAAP,KAAmB,WAAnB,IAAkC0B,IAAI,CAACE,MAAL,KAAgB,CAAtD,EAAyD,OAAOD,CAAP;AACzD,WAAOtF,EAAE,CAACe,YAAH,CACLf,EAAE,CAAC4D,YAAH,OAAA5D,EAAE,GAAcsF,CAAd,EAAiB3B,OAAjB,WAAiBA,OAAjB,GAA4B3D,EAAE,CAACoB,SAA/B,SAA6CiE,IAA7C,EADG,CAAP;AAGD,GALM,CAAP;AAMD;SAEeG,GAAGxF,IAAeyF,GAAkBC;AAClD,SAAO1F,EAAE,CAAC2F,IAAH,CAAQvB,IAAI,CAACpE,EAAD,EAAK,WAAL,EAAkBoB,SAAlB,EAA6BqE,CAA7B,EAAgCC,CAAhC,CAAZ,CAAP;AACD;SAUeE,eAAe5F,IAAeyF;AAC5C,SAAOzF,EAAE,CAAC2F,IAAH,CACLvB,IAAI,CACFpE,EADE,6EAGFoB,SAHE,EAIFqE,CAJE,CADC,CAAP;AAQD;SAEeI,KAAK7F,IAAe8F;AAClC,MAAMC,IAAI,GAAGC,IAAI,CAACC,SAAL,CAAeH,MAAf,CAAb;AACA,MAAI,CAACC,IAAL,EAAW,OAAO/F,EAAE,CAACoB,SAAV;AACX,SAAOgD,IAAI,CAACpE,EAAD,gBAAmBoB,SAAnB,EAA8BpB,EAAE,CAACkG,SAAH,CAAaH,IAAb,CAA9B,CAAX;AACD;SAEeI,WACdC,SACAC;AAEA,MAAI;AACF,WAAOA,EAAE,CAACD,OAAD,CAAT;AACD,GAFD,SAEU;AACR,yDAAgBA,OAAhB,wCAAyB;AAAA,UAAdxD,CAAc;AACvB,UAAIA,CAAC,CAACf,KAAN,EAAae,CAAC,CAACtB,OAAF;AACd;AACF;AACF;;SCrDuBgF,kBACtBtG,IACA8F,QACApE,QACA6E;AAEA,MAAMC,KAAK,GAAGxG,EAAE,CAACyG,SAAH,EAAd;;AACA,MAAMJ,EAAE,GAAG,SAALA,EAAK,CAAC5E,GAAD,EAAgCiF,IAAhC;AACT,QAAMC,SAAS,GAAGJ,OAAO,CAAC9E,GAAD,CAAzB;AACA,QAAMmF,WAAW,GACf,OAAOF,IAAI,CAACrD,KAAZ,KAAsB,WAAtB,GAAoCjC,SAApC,GAAgDmF,OAAO,CAACG,IAAI,CAACrD,KAAN,CADzD;AAEA,QAAMwD,SAAS,GACb,OAAOH,IAAI,CAAC3E,GAAZ,KAAoB,WAApB,GAAkCX,SAAlC,GAA8CmF,OAAO,CAACG,IAAI,CAAC3E,GAAN,CADvD;AAEA,QAAM+E,SAAS,GACb,OAAOJ,IAAI,CAAClF,GAAZ,KAAoB,WAApB,GAAkCJ,SAAlC,GAA8CmF,OAAO,CAACG,IAAI,CAAClF,GAAN,CADvD;AAGAxB,IAAAA,EAAE,CAACyG,SAAH,GAAexF,OAAf,CAAuB,UAAC8F,OAAD;AACrBlC,MAAAA,MAAM,CAACmC,OAAP,CAAeN,IAAf,EAAqBO,OAArB,CAA6B;YAAEpE;YAAGf;AAChC,YAAM0B,EAAE,GACNX,CAAC,KAAK,OAAN,GACI+D,WADJ,GAEI/D,CAAC,KAAK,KAAN,GACAgE,SADA,GAEAhE,CAAC,KAAK,KAAN,GACAiE,SADA,GAEAhF,CAAC,GACD9B,EAAE,QADD,GAEDA,EAAE,SATR;;AAUA,YAAIwD,EAAJ,EAAQ;AACNxD,UAAAA,EAAE,CAACkH,OAAH,CAAWH,OAAX,EAAoBlE,CAApB,EAAuBW,EAAvB;AACD;AACF,OAdD;AAeAxD,MAAAA,EAAE,CAACkH,OAAH,CAAWV,KAAX,EAAkBG,SAAlB,EAA6BI,OAA7B;AACD,KAjBD;AAkBD,GA3BD;;AA6BA,MAAML,IAAI,GAAG7B,MAAM,CAACE,yBAAP,CAAiCe,MAAjC,CAAb;AACAjB,EAAAA,MAAM,CAACmC,OAAP,CAAeN,IAAf,EAAqBO,OAArB,CAA6B;AAAA,QAAEpE,CAAF;AAAA,QAAKf,CAAL;AAAA,WAAYuE,EAAE,CAACxD,CAAD,EAAIf,CAAJ,CAAd;AAAA,GAA7B;AACA+C,EAAAA,MAAM,CAACsC,qBAAP,CAA6BT,IAA7B,EAAmCO,OAAnC,CAA2C,UAACpE,CAAD;AAAA,WAAOwD,EAAE,CAACxD,CAAD,EAAK6D,IAAY,CAAC7D,CAAD,CAAjB,CAAT;AAAA,GAA3C;AAEAuB,EAAAA,IAAI,CAACpE,EAAD,6BAAgCoB,SAAhC,EAA2CM,MAA3C,EAAmD8E,KAAnD,CAAJ,CAA8DlF,OAA9D;AAEAkF,EAAAA,KAAK,CAAClF,OAAN;AACD;;SCzCuB8F,gBACtBpH,IACA8F,QACAS,SACAc,WACAC,YAIAC;;;AAEA,MAAI,OAAOzB,MAAP,KAAkB,UAAtB,EAAkC;AAElC,MAAM0B,GAAG,GAAGxH,EAAE,CACXyH,WADS,CACG3B,MAAM,CAAC4B,IADV,EACgB;;;AACxB,QAAMC,IAAI,GAAGN,SAAS,CAAC,IAAD,CAAtB;AACA,QAAMhC,IAAI,GAAG,yBAAWuC,GAAX,CAAe,UAACnC,CAAD;AAAA,aAAO4B,SAAS,CAAC5B,CAAD,CAAhB;AAAA,KAAf,CAAb;;AAEA,QAAI3B,aAAa,CAACgC,MAAD,CAAb,IAAyBzB,QAAQ,CAACsD,IAAD,CAArC,EAA6C;AAC3C;AACA,UAAM7G,MAAM,cAAOgF,MAAP,EAAiBT,IAAjB,CAAZ;;AACAR,MAAAA,MAAM,CAACmC,OAAP,CAAelG,MAAf,EAAuBmG,OAAvB,CAA+B;YAAExF;YAAK4B;AACpCrD,QAAAA,EAAE,CAACkH,OAAH,CAAW,KAAX,EAAiBzF,GAAjB,EAAsB8E,OAAO,CAAClD,KAAD,CAA7B;AACD,OAFD;AAGA,aAAO,IAAP;AACD;;AAED,WAAOkD,OAAO,CACZgB,QAAQ,GAAGA,QAAQ,CAACzB,MAAD,EAAS6B,IAAT,EAAetC,IAAf,CAAX,GAAkCS,MAAM,CAAC+B,KAAP,CAAaF,IAAb,EAAmBtC,IAAnB,CAD9B,CAAd;AAGD,GAjBS,EAkBTpE,OAlBS,CAkBD,UAACW,OAAD;AAAA;AAEPwC,MAAAA,IAAI,CACFpE,EADE,4LAQFoB,SARE,EASFQ,OATE;AAFG;AAAA,GAlBC,CAAZ;AAiCA,MAAMF,MAAM,kBAAG4F,UAAU,CAACxB,MAAD,EAAS0B,GAAT,CAAb,0BAA8BA,GAA1C;AACAlB,EAAAA,iBAAiB,CAACtG,EAAD,EAAK8F,MAAL,EAAa0B,GAAb,EAAkBjB,OAAlB,CAAjB;AAEA,SAAO7E,MAAP;AACD;;SCnDuBoG,cACtB9H,IACA8F,QACAS,SACAe;;;AAKA,MAAI,OAAOxB,MAAP,KAAkB,QAAlB,IAA8BA,MAAM,KAAK,IAA7C,EAAmD;AAEnD,MAAM0B,GAAG,GAAG/C,KAAK,CAACC,OAAN,CAAcoB,MAAd,IAAwB9F,EAAE,CAAC+H,QAAH,EAAxB,GAAwC/H,EAAE,CAACyG,SAAH,EAApD;AACA,MAAM/E,MAAM,kBAAG4F,UAAU,CAACxB,MAAD,EAAS0B,GAAT,CAAb,0BAA8BA,GAA1C;;AAGA,MAAMtD,SAAS,GAAGW,MAAM,CAACC,cAAP,CAAsBgB,MAAtB,CAAlB;AACA,MAAMkC,eAAe,GACnB9D,SAAS,IAAIA,SAAS,KAAKW,MAAM,CAACX,SAAlC,IAA+CA,SAAS,KAAKO,KAAK,CAACP,SAAnE,GACIqC,OAAO,CAACrC,SAAD,CADX,GAEI9C,SAHN;;AAIA,MAAI4G,eAAJ,EAAqB;AACnB5D,IAAAA,IAAI,CACFpE,EADE,EAEF,uBAFE,EAGFoB,SAHE,EAIFM,MAJE,EAKFsG,eALE,CAAJ,CAME1G,OANF;AAOD;;AAEDgF,EAAAA,iBAAiB,CAACtG,EAAD,EAAK8F,MAAL,EAAa0B,GAAb,EAAkBjB,OAAlB,CAAjB;AAEA,SAAO7E,MAAP;AACD;;ACpCD;SAEwBuG,iBACtBjI,IACA8F;AAEA,UAAQ,OAAOA,MAAf;AACE,SAAK,WAAL;AACE,aAAO9F,EAAE,CAACoB,SAAV;;AACF,SAAK,QAAL;AACE,aAAOpB,EAAE,CAACiC,SAAH,CAAa6D,MAAb,CAAP;;AACF,SAAK,QAAL;AACE,aAAO9F,EAAE,CAACkG,SAAH,CAAaJ,MAAb,CAAP;;AACF,SAAK,SAAL;AACE,aAAOA,MAAM,GAAG9F,EAAE,QAAL,GAAaA,EAAE,SAA5B;;AACF,SAAK,QAAL;AACE,aAAO8F,MAAM,KAAK,IAAX,GAAkB9F,EAAE,QAApB,GAA4BoB,SAAnC;AAEF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAnBF;;AAsBA,SAAOA,SAAP;AACD;;SC3BuB8G,cACtBlI,IACA8F,QACAwB;;;AAKA,MAAI,OAAOxB,MAAP,KAAkB,QAAtB,EAAgC;AAChC,MAAMpE,MAAM,GAAG0C,IAAI,CACjBpE,EADiB,EAEjB,gBAFiB,EAGjBoB,SAHiB,EAIjB0E,MAAM,CAACqC,WAAP,GAAqBnI,EAAE,CAACkG,SAAH,CAAaJ,MAAM,CAACqC,WAApB,CAArB,GAAwDnI,EAAE,CAACoB,SAJ1C,CAAnB;AAMA,wBAAOkG,UAAU,CAACxB,MAAD,EAASpE,MAAT,CAAjB,0BAAqCA,MAArC;AACD;;SCJe6E,QAAQT,QAAiBsC;;;AACvC,MAAQpI,EAAR,GAAoDoI,OAApD,CAAQpI,EAAR;AAAA,MAAYqH,SAAZ,GAAoDe,OAApD,CAAYf,SAAZ;AAAA,MAAuBgB,aAAvB,GAAoDD,OAApD,CAAuBC,aAAvB;AAAA,MAAsCC,IAAtC,GAAoDF,OAApD,CAAsCE,IAAtC;AAAA,MAA4CC,GAA5C,GAAoDH,OAApD,CAA4CG,GAA5C;AAEA;AACE,QAAMC,SAAS,GAAGP,gBAAgB,CAACjI,EAAD,EAAK8F,MAAL,CAAlC;;AACA,QAAI0C,SAAJ,EAAe;AACb,aAAOA,SAAP;AACD;AACF;AAED;AACE,QAAM9G,MAAM,GAAG4G,IAAI,CAACxC,MAAD,CAAnB;AACA,QAAIpE,MAAJ,EAAY,OAAOA,MAAP;AACb;;AAED,MAAI,CAAA2G,aAAa,QAAb,YAAAA,aAAa,CAAGvC,MAAH,CAAb,MAA4B,KAAhC,EAAuC;AACrC,WAAO9F,EAAE,CAACoB,SAAV;AACD;;AAED,MAAMqH,QAAQ,GAAG,SAAXA,QAAW,CAACC,CAAD;AAAA,WAAgBnC,OAAO,CAACmC,CAAD,EAAIN,OAAJ,CAAvB;AAAA,GAAjB;;AAEA,MAAMtH,MAAM,sCACVoH,aAAa,CAAClI,EAAD,EAAK8F,MAAL,EAAayC,GAAb,CADH,6BAEVnB,eAAe,CAACpH,EAAD,EAAK8F,MAAL,EAAa2C,QAAb,EAAuBpB,SAAvB,EAAkCkB,GAAlC,EAAuCH,OAAO,CAACb,QAA/C,CAFL,oBAGVO,aAAa,CAAC9H,EAAD,EAAK8F,MAAL,EAAa2C,QAAb,EAAuBF,GAAvB,CAHH,mBAIVvI,EAAE,CAACoB,SAJL;AAMA,SAAON,MAAP;AACD;;SCxCuB6H,oBACtB3I,IACA0B,QACAoE,QACAuB;AAEArH,EAAAA,EAAE,CAACyH,WAAH,CAAe,EAAf,EAAmB,UAAChG,GAAD,EAAM4B,KAAN;AACjB,qBAAkBgE,SAAS,CAAC5F,GAAD,CAA3B;AAAA,QAAOmH,OAAP;;AACA,QACE,OAAOA,OAAP,KAAmB,QAAnB,IACA,OAAOA,OAAP,KAAmB,QADnB,IAEA,OAAOA,OAAP,KAAmB,QAHrB,EAKE;AAEF,QAAMlC,IAAI,GACR,CACE,CAAC,OAAD,EAAU,IAAV,CADF,EAEE,CAAC,KAAD,EAAQ,IAAR,CAFF,EAGE,CAAC,KAAD,EAAQ,IAAR,CAHF,EAIE,CAAC,cAAD,EAAiB,KAAjB,CAJF,EAKE,CAAC,YAAD,EAAe,KAAf,CALF,EAME,CAAC,UAAD,EAAa,KAAb,CANF,EAQAmC,MARA,CAQ2B,UAACnC,IAAD;UAAQjF;UAAKqH;AACxC,UAAMlG,CAAC,GAAG5C,EAAE,CAACqB,OAAH,CAAWgC,KAAX,EAAkB5B,GAAlB,CAAV;AACA,UAAMsH,EAAE,GAAG/I,EAAE,UAAF,CAAU4C,CAAV,CAAX;AAEA,UAAImG,EAAE,KAAK,WAAX,EAAwB,OAAOrC,IAAP;;AACxB,UAAI,CAACoC,WAAD,IAAgBC,EAAE,KAAK,SAA3B,EAAsC;AACpCrC,QAAAA,IAAI,CAACjF,GAAD,CAAJ,GAAYzB,EAAE,CAAC2F,IAAH,CAAQ3F,EAAE,CAACqB,OAAH,CAAWgC,KAAX,EAAkB5B,GAAlB,CAAR,CAAZ;AACA,eAAOiF,IAAP;AACD;;AAED,wBAA2BW,SAAS,CAACzE,CAAD,CAApC;AAAA,UAAOd,CAAP;AAAA,UAAUkH,aAAV;;AACA,UAAIA,aAAJ,EAAmB;AACjBpG,QAAAA,CAAC,CAACtB,OAAF;AACD;;AACDoF,MAAAA,IAAI,CAACjF,GAAD,CAAJ,GAAYK,CAAZ;AAEA,aAAO4E,IAAP;AACD,KAzBC,EAyBC,EAzBD,CADF;AA4BA7B,IAAAA,MAAM,CAACoE,cAAP,CAAsBnD,MAAtB,EAA8B8C,OAA9B,EAAuClC,IAAvC;AACD,GAtCD,EAsCGzF,OAtCH,CAsCW,UAACC,EAAD;AACTkD,IAAAA,IAAI,CACFpE,EADE,iOAOFoB,SAPE,EAQFM,MARE,EASFR,EATE,CAAJ,CAUEI,OAVF;AAWD,GAlDD;AAmDD;;SCxDuB4H,kBACtBlJ,IACA0B,QACA6E,SACAc,WACA8B;;;AAEA,MAAInJ,EAAE,UAAF,CAAU0B,MAAV,MAAsB,UAA1B,EAAsC;;AAEtC,MAAM8F,GAAG,GAAG;AACV,QAAM4B,UAAU,GAAG7C,OAAO,CAAC,IAAD,CAA1B;AACA,QAAM8C,UAAU,GAAG,yBAAKzB,GAAL,CAAS,UAACnC,CAAD;AAAA,aAAOc,OAAO,CAACd,CAAD,CAAd;AAAA,KAAT,CAAnB;;AAEA,6DAAgB;AACd,uBAAmB4B,SAAS,CAC1BjD,IAAI,MAAJ,UACEpE,EADF,wCAGEoJ,UAHF,EAIE1H,MAJF,SAKK2H,UALL,EAD0B,CAA5B;AAAA,UAAOC,QAAP;;AASAzE,MAAAA,MAAM,CAAC0E,gBAAP,CAAwB,IAAxB,EAA8B1E,MAAM,CAACE,yBAAP,CAAiCuE,QAAjC,CAA9B;AACA,aAAO,IAAP;AACD;;AAED,QAAME,YAAY,GAAGxJ,EAAE,CAACe,YAAH,CACnBf,EAAE,CAAC4D,YAAH,OAAA5D,EAAE,GAAc0B,MAAd,EAAsB0H,UAAtB,SAAqCC,UAArC,EADiB,CAArB;;AAGA,sBAAgChC,SAAS,CAACmC,YAAD,CAAzC;AAAA,QAAO1I,MAAP;AAAA,QAAekI,aAAf;;AACA,QAAIA,aAAJ,EAAmBQ,YAAY,CAAClI,OAAb;AACnB,WAAOR,MAAP;AACD,GAxBD;;AA0BA,MAAM2I,IAAI,oBAAGN,YAAY,CAAC3B,GAAD,EAAM9F,MAAN,CAAf,4BAAgC8F,GAA1C;AACAmB,EAAAA,mBAAmB,CAAC3I,EAAD,EAAK0B,MAAL,EAAa8F,GAAb,EAAkBH,SAAlB,CAAnB;AAEA,SAAOoC,IAAP;AACD;;SCvCuBC,gBACtB1J,IACA0B,QACA2F,WACA8B;;;AAEA,MACEnJ,EAAE,UAAF,CAAU0B,MAAV,MAAsB,QAAtB;AAEA1B,EAAAA,EAAE,CACCe,YADH,CACgBf,EAAE,CAACgB,QAAH,CAAY,iBAAZ,CADhB,EAEGC,OAFH,CAEW,UAACqC,CAAD;AAAA,WACPtD,EAAE,CAAC2F,IAAH,CAAQ3F,EAAE,CAACe,YAAH,CAAgBf,EAAE,CAAC4D,YAAH,CAAgBN,CAAhB,EAAmBtD,EAAE,CAACoB,SAAtB,EAAiCM,MAAjC,CAAhB,CAAR,CADO;AAAA,GAFX,CAHF,EASE;AAEF,MAAM8F,GAAG,GAAGpD,IAAI,CAACpE,EAAD,EAAK,eAAL,EAAsBoB,SAAtB,EAAiCM,MAAjC,CAAJ,CAA6CT,OAA7C,CAAqD,UAAC0I,CAAD;AAAA,WAC/D3J,EAAE,CAAC2F,IAAH,CAAQgE,CAAR,CAD+D;AAAA,GAArD,IAGR,EAHQ,GAIR,EAJJ;AAKA,MAAMC,GAAG,oBAAGT,YAAY,CAAC3B,GAAD,EAAM9F,MAAN,CAAf,4BAAgC8F,GAAzC;AAEA,MAAMtD,SAAS,GAAGE,IAAI,CACpBpE,EADoB,mJAMpBoB,SANoB,EAOpBM,MAPoB,CAAJ,CAQhBT,OARgB,CAQR,UAACiD,SAAD;AACR,QAAIlE,EAAE,UAAF,CAAUkE,SAAV,MAAyB,WAA7B,EAA0C;;AAC1C,qBAAgBmD,SAAS,CAACnD,SAAD,CAAzB;AAAA,QAAOU,KAAP;;AACA,WAAOA,KAAP;AACD,GAZiB,CAAlB;;AAaA,MAAI,OAAOV,SAAP,KAAqB,QAAzB,EAAmC;AACjCW,IAAAA,MAAM,CAACgF,cAAP,CAAsBD,GAAtB,EAA2B1F,SAA3B;AACD;;AAEDyE,EAAAA,mBAAmB,CAAC3I,EAAD,EAAK0B,MAAL,EAAa8F,GAAb,EAAkBH,SAAlB,CAAnB;AAEA,SAAOuC,GAAP;AACD;;SC9CuBE,mBACtB9J,IACA0B;AAEA,MAAMqH,EAAE,GAAG/I,EAAE,UAAF,CAAU0B,MAAV,CAAX;;AACA,MACEqH,EAAE,KAAK,WAAP,IACAA,EAAE,KAAK,QADP,IAEAA,EAAE,KAAK,QAFP,IAGAA,EAAE,KAAK,SAJT,EAKE;AACA,WAAO,CAAC/I,EAAE,CAAC2F,IAAH,CAAQjE,MAAR,CAAD,EAAkB,IAAlB,CAAP;AACD,GAPD,MAOO,IAAIqH,EAAE,KAAK,QAAX,EAAqB;AAC1B,QAAMgB,MAAM,GAAG/J,EAAE,CACde,YADY,CACCf,EAAE,CAACgB,QAAH,CAAY,iBAAZ,CADD,EAEZC,OAFY,CAEJ,UAACqC,CAAD;AAAA,aACPtD,EAAE,CAAC2F,IAAH,CAAQ3F,EAAE,CAACe,YAAH,CAAgBf,EAAE,CAAC4D,YAAH,CAAgBN,CAAhB,EAAmBtD,EAAE,CAACoB,SAAtB,EAAiCM,MAAjC,CAAhB,CAAR,CADO;AAAA,KAFI,CAAf;;AAKA,QAAIqI,MAAJ,EAAY;AACV,aAAO,CAAC,IAAD,EAAO,IAAP,CAAP;AACD;AACF;AAGD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAEA,SAAO,CAAC3I,SAAD,EAAY,KAAZ,CAAP;AACD;;SClCuB4I,gBACtBhK,IACA0B,QACAyH;;;AAEA,MAAInJ,EAAE,UAAF,CAAU0B,MAAV,MAAsB,QAA1B,EAAoC;AACpC,MAAMgF,IAAI,GAAG1G,EAAE,CAACiK,SAAH,CAAajK,EAAE,CAACqB,OAAH,CAAWK,MAAX,EAAmB,aAAnB,CAAb,CAAb;AACA,MAAMwI,GAAG,GAAGrK,MAAM,CAAC6G,IAAD,CAAlB;AACA,0BAAOyC,YAAY,CAACe,GAAD,EAAMxI,MAAN,CAAnB,4BAAoCwI,GAApC;AACD;;SCEe7C,UAAU3F,QAAuB0G;AAC/C,wBAAiB+B,cAAc,CAACzI,MAAD,EAAS0G,OAAT,CAA/B;AAAA,MAAOtH,MAAP;;AACA,SAAOA,MAAP;AACD;;AAED,SAASqJ,cAAT,CACEzI,MADF,EAEE0G,OAFF;;;AAIE,MAAQpI,EAAR,GAAmCoI,OAAnC,CAAQpI,EAAR;AAAA,MAAYuG,OAAZ,GAAmC6B,OAAnC,CAAY7B,OAAZ;AAAA,MAAqB+B,IAArB,GAAmCF,OAAnC,CAAqBE,IAArB;AAAA,MAA2BC,GAA3B,GAAmCH,OAAnC,CAA2BG,GAA3B;AAEA;AACE,8BAAqBuB,kBAAkB,CAAC9J,EAAD,EAAK0B,MAAL,CAAvC;AAAA,QAAOoE,MAAP;AAAA,QAAesE,EAAf;;AACA,QAAIA,EAAJ,EAAQ,OAAO,CAACtE,MAAD,EAAS,KAAT,CAAP;AACT;AAED;AACE,QAAMA,OAAM,GAAGwC,IAAI,CAAC5G,MAAD,CAAnB;;AACA,QAAIoE,OAAJ,EAAY;AACV,aAAO,CAACA,OAAD,EAAS,IAAT,CAAP;AACD;AACF;;AAED,MAAMuE,UAAU,GAAG,SAAbA,UAAa,CAACzH,CAAD;AAAA,WAAsBuH,cAAc,CAACvH,CAAD,EAAIwF,OAAJ,CAApC;AAAA,GAAnB;;AAEA,MAAMtH,MAAM,+BACVkJ,eAAe,CAAChK,EAAD,EAAK0B,MAAL,EAAa6G,GAAb,CADL,+BAEVW,iBAAiB,CAAClJ,EAAD,EAAK0B,MAAL,EAAa6E,OAAb,EAAsB8D,UAAtB,EAAkC9B,GAAlC,CAFP,mBAGVmB,eAAe,CAAC1J,EAAD,EAAK0B,MAAL,EAAa2I,UAAb,EAAyB9B,GAAzB,CAHjB;AAKA,SAAO,CAACzH,MAAD,EAAS,KAAT,CAAP;AACD;;SCpCewJ,KACdtK,IACA8F,QACAyE,gBACAC,sBACAjE,SACAkE;AAEA,MAAI,CAACpG,QAAQ,CAACyB,MAAD,CAAb,EAAuB,OAAO1E,SAAP;AACvB,MAAIsJ,SAAS,CAAC5E,MAAD,EAASyE,cAAT,CAAb,EAAuC,OAAOzE,MAAP;AAEvC,MAAM6E,GAAG,GAAG,IAAIC,KAAJ,CAAU9E,MAAV,EAAyB;AACnC/D,IAAAA,GADmC,eAC/B6H,GAD+B,EAC1BnI,GAD0B;AAEjC,aAAOA,GAAG,KAAK8I,cAAR,GAAyBX,GAAzB,GAA+BiB,OAAO,CAAC9I,GAAR,CAAY6H,GAAZ,EAAiBnI,GAAjB,CAAtC;AACD,KAHkC;AAInCD,IAAAA,GAJmC,eAI/BoI,GAJ+B,EAI1BnI,GAJ0B,EAIrB4B,KAJqB,EAIdyH,QAJc;;;AAKjC,UAAMhJ,CAAC,GAAGiJ,MAAM,CAAC1H,KAAD,EAAQkH,cAAR,CAAhB;AACA,UAAMS,IAAI,gBAAGP,QAAH,oBAAGA,QAAQ,CAAGK,QAAH,CAAX,wBAA2B,MAArC;;AACA,UAAIE,IAAI,KAAK,IAAT,IAAiBH,OAAO,CAACrJ,GAAR,CAAYoI,GAAZ,EAAiBnI,GAAjB,EAAsBK,CAAtB,EAAyBgJ,QAAzB,CAArB,EAAyD;AACvD,YAAIE,IAAI,KAAK,MAAb,EAAqB,OAAO,IAAP;;AACrB,4BAA6BC,YAAY,CACvCjL,EADuC,EAEvCuG,OAAO,CAACuE,QAAD,CAFgC,EAGvCN,oBAHuC,CAAzC;AAAA,YAAO5I,OAAP;AAAA,YAAgBsJ,SAAhB;;AAKA,YAAIA,SAAJ,EAAe;AACbtJ,UAAAA,OAAO,CAACX,OAAR,CAAgB,UAAC2B,CAAD;AAAA,mBAAO5C,EAAE,CAACkH,OAAH,CAAWtE,CAAX,EAAc2D,OAAO,CAAC9E,GAAD,CAArB,EAA4B8E,OAAO,CAACzE,CAAD,CAAnC,CAAP;AAAA,WAAhB;AACD,SAFD,MAEO;AACL9B,UAAAA,EAAE,CAACkH,OAAH,CAAWtF,OAAX,EAAoB2E,OAAO,CAAC9E,GAAD,CAA3B,EAAkC8E,OAAO,CAACzE,CAAD,CAAzC;AACD;AACF;;AACD,aAAO,IAAP;AACD,KArBkC;AAsBnCqJ,IAAAA,cAtBmC,0BAsBpBvB,GAtBoB,EAsBfnI,GAtBe;;;AAuBjC,UAAMuJ,IAAI,iBAAGP,QAAH,oBAAGA,QAAQ,CAAGE,GAAH,CAAX,yBAAsB,MAAhC;;AACA,2BAA6BM,YAAY,CACvCjL,EADuC,EAEvCuG,OAAO,CAACoE,GAAD,CAFgC,EAGvCH,oBAHuC,CAAzC;AAAA,UAAO5I,OAAP;AAAA,UAAgBsJ,SAAhB;;AAKA,UAAIF,IAAI,KAAK,IAAT,IAAiBH,OAAO,CAACM,cAAR,CAAuBvB,GAAvB,EAA4BnI,GAA5B,CAArB,EAAuD;AACrD,YAAIuJ,IAAI,KAAK,MAAb,EAAqB,OAAO,IAAP;;AACrB,YAAIE,SAAJ,EAAe;AACbtJ,UAAAA,OAAO,CAACX,OAAR,CAAgB,UAAC2B,CAAD;AAAA,mBACdwB,IAAI,CAACpE,EAAD,2BAA8BoB,SAA9B,EAAyCwB,CAAzC,EAA4C2D,OAAO,CAAC9E,GAAD,CAAnD,CADU;AAAA,WAAhB;AAGD,SAJD,MAIO;AACL2C,UAAAA,IAAI,CAACpE,EAAD,2BAA8BoB,SAA9B,EAAyCQ,OAAzC,EAAkD2E,OAAO,CAAC9E,GAAD,CAAzD,CAAJ;AACD;AACF;;AACD,aAAO,IAAP;AACD;AAxCkC,GAAzB,CAAZ;AA0CA,SAAOkJ,GAAP;AACD;SAEeS,WACdpL,IACA0B,QACA6I,gBACAC,sBACAnD,WACAoD;AAEA,MAAI,CAAC7E,cAAc,CAAC5F,EAAD,EAAK0B,MAAL,CAAnB,EAAiC,OAAO,CAACN,SAAD,EAAY,KAAZ,CAAP;AACjC,MAAIiK,eAAe,CAACrL,EAAD,EAAK0B,MAAL,EAAa8I,oBAAb,CAAnB,EAAuD,OAAO,CAAC9I,MAAD,EAAS,KAAT,CAAP;AAEvD,SAAOyE,UAAU,CACf,CACEnG,EAAE,CAACyH,WAAH,CAAe,aAAf,EAA8B,UAAC7E,CAAD;AAC5B,QAAM0I,GAAG,GAAGb,QAAH,oBAAGA,QAAQ,CAAGpD,SAAS,CAACzE,CAAD,CAAZ,CAApB;AACA,QAAI,OAAO0I,GAAP,KAAe,QAAnB,EAA6B,OAAOtL,EAAE,CAACkG,SAAH,CAAaoF,GAAb,CAAP;AAC7B,WAAOtL,EAAE,CAACoB,SAAV;AACD,GAJD,CADF,EAMEpB,EAAE,CAACyH,WAAH,CAAe,QAAf,EAAyB,UAAC7E,CAAD,EAAI+D,SAAJ,EAAeC,WAAf;AACvB,QAAMd,MAAM,GAAGuB,SAAS,CAACzE,CAAD,CAAxB;AACA,QAAI,CAACkD,MAAL,EAAa;AACb,QAAMrE,GAAG,GAAG4F,SAAS,CAACV,SAAD,CAArB;AACA,QAAIlF,GAAG,KAAK,WAAZ,EAAyB;;AACzB,QAAM4B,KAAK,GAAGgE,SAAS,CAACT,WAAD,CAAvB;AACAmE,IAAAA,MAAM,CAACjF,MAAD,EAASyE,cAAT,CAAN,CAA+B9I,GAA/B,IAAsC4B,KAAtC;AACD,GAPD,CANF,EAcErD,EAAE,CAACyH,WAAH,CAAe,SAAf,EAA0B,UAAC7E,CAAD,EAAI+D,SAAJ;AACxB,QAAMb,MAAM,GAAGuB,SAAS,CAACzE,CAAD,CAAxB;AACA,QAAI,CAACkD,MAAL,EAAa;AACb,QAAMrE,GAAG,GAAG4F,SAAS,CAACV,SAAD,CAArB;AACA,WAAOoE,MAAM,CAACjF,MAAD,EAASyE,cAAT,CAAN,CAA+B9I,GAA/B,CAAP;AACD,GALD,CAdF,CADe,EAsBf,UAAC4D,IAAD;AAAA,WAAU,CACRjB,IAAI,MAAJ,UACEpE,EADF,qmCA+BEoB,SA/BF,EAgCEM,MAhCF,EAiCE8I,oBAjCF,SAkCKnF,IAlCL,EADQ,EAqCR,IArCQ,CAAV;AAAA,GAtBe,CAAjB;AA8DD;SAEe0F,OAAUnB,KAAQnI;;;AAChC,SAAO4C,QAAQ,CAACuF,GAAD,CAAR,eAAkBA,GAAW,CAACnI,GAAD,CAA7B,uBAA4CmI,GAA5C,GAAkDA,GAAzD;AACD;SAEeqB,aACdjL,IACA0B,QACAD;AAEA,MAAI,CAAC4J,eAAe,CAACrL,EAAD,EAAK0B,MAAL,EAAaD,GAAb,CAApB,EAAuC,OAAO,CAACC,MAAD,EAAS,KAAT,CAAP;AACvC,SAAO,CAAC1B,EAAE,CAACqB,OAAH,CAAWK,MAAX,EAAmBD,GAAnB,CAAD,EAA0B,IAA1B,CAAP;AACD;SAEeiJ,UAAad,KAAQnI;AACnC,SAAO4C,QAAQ,CAACuF,GAAD,CAAR,IAAiB,CAAC,CAAEA,GAAW,CAACnI,GAAD,CAAtC;AACD;SAEe4J,gBACdrL,IACA0B,QACAD;AAEA,SAAO,CAAC,CAACzB,EAAE,CAAC2F,IAAH,CACPvB,IAAI,CACFpE,EADE,8FAGFoB,SAHE,EAIFM,MAJE,EAKFD,GALE,CADG,CAAT;AASD;;AC1KD;;;IAGa8J,wBAAwB;AAEnC,CAAC1L,MAAD,EAAS,QAAT,CAFmC,EAGnC,CAACA,MAAM,CAACqE,SAAR,EAAmB,kBAAnB,CAHmC,EAInC,CAACW,MAAD,EAAS,QAAT,CAJmC,EAKnC,CAACA,MAAM,CAACX,SAAR,EAAmB,kBAAnB,CALmC,EAMnC,CAACD,QAAD,EAAW,UAAX,CANmC,EAOnC,CAACA,QAAQ,CAACC,SAAV,EAAqB,oBAArB,CAPmC,EAQnC,CAACsH,OAAD,EAAU,SAAV,CARmC,EASnC,CAACA,OAAO,CAACtH,SAAT,EAAoB,mBAApB,CATmC,EAUnC,CAACO,KAAD,EAAQ,OAAR,CAVmC,EAWnC,CAACA,KAAK,CAACP,SAAP,EAAkB,iBAAlB,CAXmC;AAanC;AACA;AACA,CAACuH,KAAD,EAAQ,OAAR,CAfmC,EAgBnC,CAACA,KAAK,CAACvH,SAAP,EAAkB,iBAAlB,CAhBmC,EAiBnC,CAACwH,SAAD,EAAY,WAAZ,CAjBmC,EAkBnC,CAACA,SAAS,CAACxH,SAAX,EAAsB,qBAAtB,CAlBmC,EAmBnC,CAACyH,UAAD,EAAa,YAAb,CAnBmC,EAoBnC,CAACA,UAAU,CAACzH,SAAZ,EAAuB,sBAAvB,CApBmC,EAqBnC,CAAC0H,cAAD,EAAiB,gBAAjB,CArBmC,EAsBnC,CAACA,cAAc,CAAC1H,SAAhB,EAA2B,0BAA3B,CAtBmC,EAuBnC,CAAC2H,WAAD,EAAc,aAAd,CAvBmC,EAwBnC,CAACA,WAAW,CAAC3H,SAAb,EAAwB,uBAAxB,CAxBmC,EAyBnC,CAAC4H,SAAD,EAAY,WAAZ,CAzBmC,EA0BnC,CAACA,SAAS,CAAC5H,SAAX,EAAsB,qBAAtB,CA1BmC,EA2BnC,CAAC6H,QAAD,EAAW,UAAX,CA3BmC,EA4BnC,CAACA,QAAQ,CAAC7H,SAAV,EAAqB,oBAArB,CA5BmC,SA8BhCW,MAAM,CAACmH,mBAAP,CAA2BnM,MAA3B,EACA8C,MADA,CACO,UAACE,CAAD;AAAA,SAAO,OAAQhD,MAAc,CAACgD,CAAD,CAAtB,KAA8B,QAArC;AAAA,CADP,EAEA+E,GAFA,CAEmB,UAAC/E,CAAD;AAAA,SAAO,CAAEhD,MAAc,CAACgD,CAAD,CAAhB,cAA+BA,CAA/B,CAAP;AAAA,CAFnB,CA9BgC;;ACqCrC;;;;IAGaoJ,KAAb;AAWE;AACA,iBAAYjM,EAAZ,EAA2BoI,OAA3B;;;SAXApI;SACAkM;SACAC;SACAC,wBAAkC,IAAI5L,GAAJ;SAClC6L,QAAkB,IAAI7L,GAAJ;SAClB8L,gBAA0B,IAAI9L,GAAJ;SAC1B+L,UAAU1M,MAAM;SAChB2M;SACAC;AAIE,SAAKzM,EAAL,GAAUA,EAAV;AACA,SAAKyM,QAAL,GAAgBrE,OAAhB;AACA,SAAKoE,aAAL,GAAqBxM,EAAE,CAACe,YAAH,CAAgBf,EAAE,CAACgB,QAAH,YAAhB,CAArB;AACA,SAAKkL,IAAL,GAAY,IAAInM,KAAJ,CAAUC,EAAV,CAAZ;AACA,SAAKmM,cAAL,GAAsB,IAAIpM,KAAJ,CAAUC,EAAV,CAAtB;AACA,SAAK0M,WAAL,0BAAiBtE,OAAjB,oBAAiBA,OAAO,CAAEuE,iBAA1B,oCAA+CpB,wBAA/C;AACD;AAED;;;;;AArBF;;AAAA,SAwBEjK,OAxBF,GAwBE;AACE,SAAK4K,IAAL,CAAU5K,OAAV;;AACA,SAAK6K,cAAL,CAAoB7K,OAApB;;AACA,SAAKkL,aAAL,CAAmBlL,OAAnB;AACD;AAED;;;AA9BF;;AAAA,SAiCEN,QAjCF,GAiCE,kBAAkBoE,IAAlB;AACE,QAAM1D,MAAM,GAAG,KAAK1B,EAAL,CAAQgB,QAAR,CAAiBoE,IAAjB,CAAf;AACA,WAAO,KAAKwH,yBAAL,CAA+BlL,MAA/B,CAAP;AACD;AAED;;;AAtCF;;AAAA,SAyCEmL,kBAzCF,GAyCE,4BAAmBC,gBAAnB;;;AACE,QAAMhM,MAAM,GAAG,KAAKd,EAAL,CAAQ6M,kBAAR,CAA2BC,gBAA3B,CAAf;;AACA,QAAI,WAAWhM,MAAf,EAAuB;AACrB,aAAOA,MAAM,CAACuC,KAAd;AACD;;AACD,UAAMvC,MAAM,CAACiM,KAAP,CAAa9L,OAAb,CAAqB,UAAC+L,GAAD;AAAA,aAAS,KAAI,CAACC,UAAL,CAAgBD,GAAhB,CAAT;AAAA,KAArB,CAAN;AACD;AAED;;;;;;AAjDF;;AAAA,SAuDEE,MAvDF,GAuDE,gBAAOtD,GAAP;AACE,uCAA2B/E,MAAM,CAACmC,OAAP,CAAe4C,GAAf,CAA3B,qCAAgD;AAA3C;AAAA,UAAOnI,GAAP;AAAA,UAAY4B,KAAZ;;AACH,UAAM3B,MAAM,GAAG,KAAKyL,QAAL,CAAc9J,KAAd,CAAf;;AACA,WAAKrD,EAAL,CAAQkH,OAAR,CAAgB,KAAKlH,EAAL,CAAQoN,MAAxB,EAAgC3L,GAAhC,EAAqCC,MAArC;AACD;AACF;AAED;;;;;AA9DF;;AAAA,SAmEEsJ,IAnEF,GAmEE,cAAQlF,MAAR;;;AACE,QAAMuH,OAAO,GAAG,KAAKC,KAAL,CAAWxH,MAAX,CAAhB;;AACA,QAAI,OAAOuH,OAAP,KAAmB,WAAvB,EAAoC,OAAOvH,MAAP;AACpCxB,IAAAA,UAAU,CAAC+I,OAAD,EAAU,UAACvL,CAAD;AAClB,MAAA,MAAI,CAACuK,KAAL,CAAW9K,GAAX,CAAe,MAAI,CAACgM,OAAL,CAAazL,CAAb,CAAf;AACD,KAFS,CAAV;AAGA,WAAOuL,OAAP;AACD;AAED;;;;;AA5EF;;AAAA,SAiFEG,QAjFF,GAiFE,kBAAS1H,MAAT,EAAsB2H,YAAtB;AACE,QAAI,KAAKtB,cAAL,CAAoB1J,GAApB,CAAwBqD,MAAxB,CAAJ,EAAqC;AACrC,QAAMpE,MAAM,GACV,OAAO+L,YAAP,KAAwB,QAAxB,GACI,KAAKC,aAAL,CAAmB,KAAK1N,EAAL,CAAQgB,QAAR,CAAiByM,YAAjB,CAAnB,CADJ,GAEIA,YAHN;AAIA,QAAIjI,EAAE,CAAC,KAAKxF,EAAN,EAAU0B,MAAV,EAAkB,KAAK1B,EAAL,CAAQoB,SAA1B,CAAN,EAA4C;;AAC5C,QAAI,OAAOqM,YAAP,KAAwB,QAA5B,EAAsC;AACpC,WAAKrB,qBAAL,CAA2B7K,GAA3B,CAA+BuE,MAA/B;AACD;;AACD,SAAKqG,cAAL,CAAoB3K,GAApB,CAAwBsE,MAAxB,EAAgCpE,MAAhC;AACD;AAED;;;AA9FF;;AAAA,SAiGEgL,WAjGF,GAiGE,qBAAY9E,GAAZ;AACE,yDAAqBA,GAArB,wCAA0B;AAAA;AAAA,UAAd/E,CAAc;AAAA,UAAXf,CAAW;AACxB,WAAK0L,QAAL,CAAc3K,CAAd,EAAiBf,CAAjB;AACD;AACF;AAED;;;AAvGF;;AAAA,SA0GE6L,UA1GF,GA0GE,oBAAW7H,MAAX,EAAwBxE,OAAxB;AACE,SAAK6K,cAAL,WACErG,MADF,EAEE,KAAKsG,qBAAL,CAA2B3J,GAA3B,CAA+BqD,MAA/B,KAA0CxE,OAF5C;;AAIA,SAAK8K,qBAAL,WAAkCtG,MAAlC;AACD;AAED;;;AAlHF;;AAAA,SAqHE8H,aArHF,GAqHE,uBAAcC,OAAd,EAAsCvM,OAAtC;AACE,0DAAgBuM,OAAhB,2CAAyB;AAAA,UAAdnF,CAAc;AACvB,WAAKiF,UAAL,CAAgBjF,CAAhB,EAAmBpH,OAAnB;AACD;AACF,GAzHH;;AAAA,SA2HEwM,SA3HF,GA2HE,mBAAUhI,MAAV;AACE,QAAI,CAACzB,QAAQ,CAACyB,MAAD,CAAb,EAAuB;;AACvB,SAAKuG,KAAL,CAAW9K,GAAX,CAAe,KAAKgM,OAAL,CAAazH,MAAb,CAAf;AACD,GA9HH;;AAAA,SAgIEiI,OAhIF,GAgIE,iBAAQjI,MAAR;AACE,SAAKuG,KAAL,WAAkB,KAAKkB,OAAL,CAAazH,MAAb,CAAlB;AACD,GAlIH;;AAAA,SAoIE4H,aApIF,GAoIE,uBAAiB5M,MAAjB;;;AACE,QAAI,WAAWA,MAAf,EAAuB;AACrB,aAAOA,MAAM,CAACuC,KAAd;AACD;;AACD,UAAMvC,MAAM,CAACiM,KAAP,CAAa9L,OAAb,CAAqB,UAAC+L,GAAD;AAAA,aAAS,MAAI,CAACC,UAAL,CAAgBD,GAAhB,CAAT;AAAA,KAArB,CAAN;AACD,GAzIH;;AAAA,SA2IEJ,yBA3IF,GA2IE,mCACE9L,MADF;;;AAGE,QAAI,CAACA,MAAL,EAAa;AACb,WAAO,KAAK4M,aAAL,CAAmB5M,MAAnB,EAA2BG,OAA3B,CAAmC,UAAC2B,CAAD;AAAA,aAAO,MAAI,CAACqK,UAAL,CAAgBrK,CAAhB,CAAP;AAAA,KAAnC,CAAP;AACD,GAhJH;;AAAA,SAkJEuK,QAlJF,GAkJE,kBAASrH,MAAT;;;;AACE,QAAMkI,UAAU,GAAG,KAAK7B,cAAL,CAAoBpK,GAApB,CAAwB+D,MAAxB,CAAnB;;AACA,QAAIkI,UAAJ,EAAgB;AACd,aAAOA,UAAP;AACD;;AAED,QAAMtM,MAAM,GAAG6E,OAAO,gBAAC,KAAK+G,KAAL,CAAWxH,MAAX,CAAD,0BAAuBA,MAAvB,EAA+B;AACnD9F,MAAAA,EAAE,EAAE,KAAKA,EAD0C;AAEnDqH,MAAAA,SAAS,EAAE,mBAACzE,CAAD;AAAA,eAAO,MAAI,CAACqK,UAAL,CAAgBrK,CAAhB,CAAP;AAAA,OAFwC;AAGnDyF,MAAAA,aAAa,EAAE,uBAACK,CAAD;AAAA;;AAAA,2DACb,MAAI,CAAC+D,QADQ,qBACb,gBAAepE,aADF,oBACb,gBAAeA,aAAf,CAA+B,MAAI,CAACkF,OAAL,CAAa7E,CAAb,CAA/B,CADa,oCACsC,IADtC;AAAA,OAHoC;AAKnDJ,MAAAA,IAAI,EAAE,cAACI,CAAD;AAAA;;AAAA,wCAAO,MAAI,CAACyD,cAAL,CAAoBpK,GAApB,CAAwB2G,CAAxB,CAAP,oCAAqC,MAAI,CAACwD,IAAL,CAAUnK,GAAV,CAAc2G,CAAd,CAArC;AAAA,OAL6C;AAMnDH,MAAAA,GAAG,EAAE,aAACG,CAAD,EAAI9F,CAAJ;AAAA;;AAAA,mCAAU,MAAI,CAACqL,SAAL,CAAevF,CAAf,EAAkB9F,CAAlB,EAAqB,MAAI,CAACsJ,IAA1B,CAAV,qBAAU,iBAAkC,CAAlC,CAAV;AAAA,OAN8C;AAOnD3E,MAAAA,QAAQ,EAAE,kBAACzB,MAAD,EAAS6B,IAAT,EAAetC,IAAf;AACR,YAAM6F,SAAS,GAAG7G,QAAQ,CAACsD,IAAD,CAAR,GAAiB,MAAI,CAAC4F,OAAL,CAAa5F,IAAb,CAAjB,GAAsCvG,SAAxD;;AAEA,YAAI8J,SAAJ,EAAe,MAAI,CAACoB,aAAL,CAAmB/K,GAAnB,CAAuB2J,SAAvB;;AACf,YAAI;AACF,iBAAOpF,MAAM,CAAC+B,KAAP,CAAaF,IAAb,EAAmBtC,IAAnB,CAAP;AACD,SAFD,SAEU;AACR;AACA,cAAI6F,SAAJ,EAAe,MAAI,CAACoB,aAAL,WAA0BpB,SAA1B;AAChB;AACF;AAjBkD,KAA/B,CAAtB;AAoBA,WAAOxJ,MAAP;AACD,GA7KH;;AAAA,SA+KEuL,UA/KF,GA+KE,oBAAWvL,MAAX;;;AACE,QAAMsM,UAAU,GAAG,KAAK7B,cAAL,CAAoB5J,WAApB,CAAgCb,MAAhC,CAAnB;;AACA,QAAI,OAAOsM,UAAP,KAAsB,WAA1B,EAAuC;AACrC,aAAOA,UAAP;AACD;;AAED,4BAAwB,KAAKE,WAAL,CAAiBxM,MAAjB,CAAxB;AAAA,QAAOyM,aAAP;;AACA,WAAO9G,SAAS,CAAC8G,aAAD,WAACA,aAAD,GAAkBzM,MAAlB,EAA0B;AACxC1B,MAAAA,EAAE,EAAE,KAAKA,EAD+B;AAExCuG,MAAAA,OAAO,EAAE,iBAACzE,CAAD;AAAA,eAAY,MAAI,CAACqL,QAAL,CAAcrL,CAAd,CAAZ;AAAA,OAF+B;AAGxCwG,MAAAA,IAAI,EAAE,cAAC1F,CAAD;AAAA;;AAAA,wCACJ,MAAI,CAACuJ,cAAL,CAAoB5J,WAApB,CAAgCK,CAAhC,CADI,oCACkC,MAAI,CAACsJ,IAAL,CAAU3J,WAAV,CAAsBK,CAAtB,CADlC;AAAA,OAHkC;AAKxC2F,MAAAA,GAAG,EAAE,aAACG,CAAD,EAAS9F,CAAT;AAAA;;AAAA,mCACH,MAAI,CAACqL,SAAL,CAAevF,CAAf,EAAkB9F,CAAlB,EAAqBxB,SAArB,EAAgC,IAAhC,CADG,qBACH,iBAAwC,CAAxC,CADG;AAAA;AALmC,KAA1B,CAAhB;AAQD,GA9LH;;AAAA,SAgME6M,SAhMF,GAgME,mBACEvF,CADF,EAEE9F,CAFF,EAGEgF,GAHF,EAIEoD,IAJF;QAGEpD;AAAAA,MAAAA,MAAa,KAAKsE;;;AAGlB,QAAI,KAAKC,cAAL,CAAoB1J,GAApB,CAAwBiG,CAAxB,KAA8B,KAAKyD,cAAL,CAAoBzJ,SAApB,CAA8BE,CAA9B,CAAlC,EAAoE;AAClE;AACD;;AAED,QAAMwL,QAAQ,GAAG,KAAKd,KAAL,CAAW5E,CAAX,CAAjB;;AACA,6BAAmB,KAAKwF,WAAL,CAAiBtL,CAAjB,CAAnB;AAAA,QAAOyL,QAAP;;AACA,QAAI,CAACD,QAAD,IAAa,CAACC,QAAlB,EAA4B;;AAE5B,QAAMC,UAAU,GAAG,KAAKf,OAAL,CAAa7E,CAAb,CAAnB;;AACA,8BAAgC,KAAK6F,aAAL,CAAmB3L,CAAnB,CAAhC;AAAA,QAAO4L,UAAP;AAAA,QAAmBtD,SAAnB;;AAEA,QAAMI,GAAG,GAAG1D,GAAG,CAACpG,GAAJ,CAAQ4M,QAAR,EAAkBC,QAAlB,EAA4BC,UAA5B,EAAwCE,UAAxC,CAAZ;;AACA,QAAI,CAAClD,GAAL,EAAU;AACR;AACA,UAAIJ,SAAJ,EAAesD,UAAU,CAAClN,OAAX;AACf,YAAM,IAAImK,KAAJ,CAAU,oBAAV,CAAN;AACD,KAJD,MAIO,IAAIT,IAAJ,EAAU;AACf,WAAKqB,KAAL,CAAW9K,GAAX,CAAe+M,UAAf;AACD;;AAED,WAAO,CAACF,QAAD,EAAWC,QAAX,CAAP;AACD,GA3NH;;AAAA,SA6NEI,SA7NF,GA6NE,mBAAU7E,GAAV;AACE,QAAM8E,IAAI,GAAG,KAAKnB,OAAL,CAAa3D,GAAb,CAAb;;AACA,WAAO,KAAKyC,KAAL,CAAW5J,GAAX,CAAeiM,IAAf,KAAwB,KAAKpC,aAAL,CAAmB7J,GAAnB,CAAuBiM,IAAvB,CAAxB,GACH,MADG,GAEHtN,SAFJ;AAGD,GAlOH;;AAAA,SAoOEkM,KApOF,GAoOE,eAASxH,MAAT;;;AACE,WAAOwE,IAAI,CACT,KAAKtK,EADI,EAET8F,MAFS,EAGT,KAAKyG,OAHI,EAIT,KAAKC,aAJI,EAKT,UAAC9D,CAAD;AAAA,aAAO,MAAI,CAACyE,QAAL,CAAczE,CAAd,CAAP;AAAA,KALS,EAMT,UAACA,CAAD;AAAA,aAAO,MAAI,CAAC+F,SAAL,CAAe/F,CAAf,CAAP;AAAA,KANS,CAAX;AAQD,GA7OH;;AAAA,SA+OE6E,OA/OF,GA+OE,iBAAWzH,MAAX;AACE,WAAOiF,MAAM,CAACjF,MAAD,EAAS,KAAKyG,OAAd,CAAb;AACD,GAjPH;;AAAA,SAmPE2B,WAnPF,GAmPE,qBACExM,MADF;;;AAGE,WAAO0J,UAAU,CACf,KAAKpL,EADU,EAEf0B,MAFe,EAGf,KAAK6K,OAHU,EAIf,KAAKC,aAJU,EAKf,UAAC5J,CAAD;AAAA,aAAO,MAAI,CAACqK,UAAL,CAAgBrK,CAAhB,CAAP;AAAA,KALe,EAMf,UAAC8F,CAAD;AAAA,aAAO,MAAI,CAAC+F,SAAL,CAAe/F,CAAf,CAAP;AAAA,KANe,CAAjB;AAQD,GA9PH;;AAAA,SAgQE6F,aAhQF,GAgQE,uBAAczI,MAAd;AACE,WAAOmF,YAAY,CAAC,KAAKjL,EAAN,EAAU8F,MAAV,EAAkB,KAAK0G,aAAvB,CAAnB;AACD,GAlQH;;AAAA;AAAA;;;;;;;;;;;;;;;;;"}