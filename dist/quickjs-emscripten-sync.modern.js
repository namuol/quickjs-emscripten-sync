let e;e=Symbol.iterator;class t{constructor(e){this.vm=void 0,this._map1=new Map,this._map2=new Map,this._map3=new Map,this._map4=new Map,this._counterMap=new Map,this._disposables=new Set,this._mapGet=void 0,this._mapSet=void 0,this._mapDelete=void 0,this._mapClear=void 0,this._counter=0,this.vm=e;const t=e.unwrapResult(e.evalCode('() => {\n        const mapSym = new Map();\n        let map = new WeakMap();\n        let map2 = new WeakMap();\n        const isObj = o => typeof o === "object" && o !== null || typeof o === "function";\n        return {\n          get: key => mapSym.get(key) ?? map.get(key) ?? map2.get(key) ?? -1,\n          set: (key, value, key2) => {\n            if (typeof key === "symbol") mapSym.set(key, value);\n            if (isObj(key)) map.set(key, value);\n            if (isObj(key2)) map2.set(key2, value);\n          },\n          delete: (key, key2) => {\n            mapSym.delete(key);\n            map.delete(key);\n            map2.delete(key2);\n          },\n          clear: () => {\n            mapSym.clear();\n            map = new WeakMap();\n            map2 = new WeakMap();\n          }\n        };\n      }')).consume(e=>this._call(e,void 0));this._mapGet=e.getProp(t,"get"),this._mapSet=e.getProp(t,"set"),this._mapDelete=e.getProp(t,"delete"),this._mapClear=e.getProp(t,"clear"),t.dispose(),this._disposables.add(this._mapGet),this._disposables.add(this._mapSet),this._disposables.add(this._mapDelete),this._disposables.add(this._mapClear)}set(e,t,n,r){var s;if(!t.alive||r&&!r.alive)return!1;const o=null!=(s=this.get(e))?s:this.get(n);if(o)return o===t||o===r;const i=this._counter++;return this._map1.set(e,i),this._map3.set(i,t),this._counterMap.set(i,e),n&&(this._map2.set(n,i),r&&this._map4.set(i,r)),this.vm.newNumber(i).consume(e=>{this._call(this._mapSet,void 0,t,e,null!=r?r:this.vm.undefined)}),!0}merge(e){if(e)for(const t of e)t&&t[1]&&this.set(t[0],t[1],t[2],t[3])}get(e){var t;const n=null!=(t=this._map1.get(e))?t:this._map2.get(e),r="number"==typeof n?this._map3.get(n):void 0;if(r){if(r.alive)return r;this.delete(e)}}getByHandle(e){if(e.alive)return this._counterMap.get(this.vm.getNumber(this._call(this._mapGet,void 0,e)))}has(e){return!!this.get(e)}hasHandle(e){return void 0!==this.getByHandle(e)}delete(e,t){var n;const r=null!=(n=this._map1.get(e))?n:this._map2.get(e);if(void 0===r)return;const s=this._map3.get(r),o=this._map4.get(r);this._call(this._mapDelete,void 0,...[s,o].filter(e=>!(null==e||!e.alive))),this._map1.delete(e),this._map2.delete(e),this._map3.delete(r),this._map4.delete(r);for(const[e,t]of this._map1)if(t===r){this._map1.delete(e);break}for(const[e,t]of this._map2)if(t===r){this._map2.delete(e);break}for(const[t,n]of this._counterMap)if(n===e){this._counterMap.delete(t);break}t&&(null!=s&&s.alive&&s.dispose(),null!=o&&o.alive&&o.dispose())}deleteByHandle(e,t){const n=this.getByHandle(e);void 0!==n&&this.delete(n,t)}clear(){this._counter=0,this._map1.clear(),this._map2.clear(),this._map3.clear(),this._map4.clear(),this._counterMap.clear(),this._mapClear.alive&&this._call(this._mapClear,void 0)}dispose(){for(const e of this._disposables.values())e.alive&&e.dispose();for(const e of this._map3.values())e.alive&&e.dispose();for(const e of this._map4.values())e.alive&&e.dispose();this._disposables.clear(),this.clear()}get size(){return this._map1.size}[e](){const e=this._map1.keys();return{next:()=>{for(;;){const t=e.next();if(t.done)return{value:void 0,done:!0};const n=this._map1.get(t.value);if(void 0===n)continue;const r=this._map3.get(n),s=this._map4.get(n);if(!r)continue;const o=this._get2(n);return{value:[t.value,r,o,s],done:!1}}}}}_get2(e){for(const[t,n]of this._map2)if(n===e)return t}_call(e,t,...n){return this.vm.unwrapResult(this.vm.callFunction(e,void 0===t?this.vm.undefined:t,...n))}}function n(e){return"function"==typeof e&&/^class\s/.test(Function.prototype.toString.call(e))}function r(e){return"function"==typeof e||"object"==typeof e&&null!==e}function s(e,t){const n=new Set,s=e=>{if(r(e)&&!n.has(e)&&!1!==(null==t?void 0:t(e,n)))if(n.add(e),Array.isArray(e))for(const t of e)s(t);else{if("object"==typeof e){const t=Object.getPrototypeOf(e);t&&t!==Object.prototype&&s(t)}for(const t of Object.values(Object.getOwnPropertyDescriptors(e)))"value"in t&&s(t.value),"get"in t&&s(t.get),"set"in t&&s(t.set)}};return s(e),n}function o(e,t){return s(e,t?(e,n)=>n.size<t:void 0).size}function i(e,t,n,...r){return e.unwrapResult(e.evalCode(t)).consume(t=>void 0===n&&0===r.length?t:e.unwrapResult(e.callFunction(t,null!=n?n:e.undefined,...r)))}function a(e,t,n){return e.dump(i(e,"Object.is",void 0,t,n))}function l(e,t){return e.dump(i(e,'a => typeof a === "object" && a !== null || typeof a === "function"',void 0,t))}function u(e,t){const n=JSON.stringify(t);return n?i(e,"JSON.parse",void 0,e.newString(n)):e.undefined}function p(e,t){try{return t(e)}finally{for(const t of e)t.alive&&t.dispose()}}function c(e,t,n,r){const s=e.newObject(),o=(t,n)=>{const o=r(t),i=void 0===n.value?void 0:r(n.value),a=void 0===n.get?void 0:r(n.get),l=void 0===n.set?void 0:r(n.set);e.newObject().consume(t=>{Object.entries(n).forEach(([n,r])=>{const s="value"===n?i:"get"===n?a:"set"===n?l:r?e.true:e.false;s&&e.setProp(t,n,s)}),e.setProp(s,o,t)})},a=Object.getOwnPropertyDescriptors(t);Object.entries(a).forEach(([e,t])=>o(e,t)),Object.getOwnPropertySymbols(a).forEach(e=>o(e,a[e])),i(e,"Object.defineProperties",void 0,n,s).dispose(),s.dispose()}function d(e,t){var s,o,a;const{vm:l,unmarshal:u,isMarshalable:p,find:h,pre:f}=t;{const t=function(e,t){switch(typeof t){case"undefined":return e.undefined;case"number":return e.newNumber(t);case"string":return e.newString(t);case"boolean":return t?e.true:e.false;case"object":return null===t?e.null:void 0}}(l,e);if(t)return t}{const t=h(e);if(t)return t}if(!1===(null==p?void 0:p(e)))return l.undefined;const y=e=>d(e,t),m=null!=(s=null!=(o=null!=(a=function(e,t,n){var r;if("symbol"!=typeof t)return;const s=i(e,"d => Symbol(d)",void 0,t.description?e.newString(t.description):e.undefined);return null!=(r=n(t,s))?r:s}(l,e,f))?a:function(e,t,s,o,a,l){var u;if("function"!=typeof t)return;const p=e.newFunction(t.name,function(...i){const a=o(this),u=i.map(e=>o(e));if(n(t)&&r(a)){const n=new t(...u);return Object.entries(n).forEach(([t,n])=>{e.setProp(this,t,s(n))}),this}return s(l?l(t,a,u):t.apply(a,u))}).consume(t=>i(e,"Cls => {\n          const fn = function(...args) { return Cls.apply(this, args); };\n          fn.name = Cls.name;\n          fn.length = Cls.length;\n          return fn;\n        }",void 0,t)),d=null!=(u=a(t,p))?u:p;return c(e,t,p,s),d}(l,e,y,u,f,t.preApply))?o:function(e,t,n,r){var s;if("object"!=typeof t||null===t)return;const o=Array.isArray(t)?e.newArray():e.newObject(),a=null!=(s=r(t,o))?s:o,l=Object.getPrototypeOf(t),u=l&&l!==Object.prototype&&l!==Array.prototype?n(l):void 0;return u&&i(e,"Object.setPrototypeOf",void 0,a,u).dispose(),c(e,t,o,n),a}(l,e,y,f))?s:l.undefined;return m}function h(e,t,n,r){e.newFunction("",(t,s)=>{const[o]=r(t);if("string"!=typeof o&&"number"!=typeof o&&"symbol"!=typeof o)return;const i=[["value",!0],["get",!0],["set",!0],["configurable",!1],["enumerable",!1],["writable",!1]].reduce((t,[n,o])=>{const i=e.getProp(s,n),a=e.typeof(i);if("undefined"===a)return t;if(!o&&"boolean"===a)return t[n]=e.dump(e.getProp(s,n)),t;const[l,u]=r(i);return u&&i.dispose(),t[n]=l,t},{});Object.defineProperty(n,o,i)}).consume(n=>{i(e,"(o, fn) => {\n        const descs = Object.getOwnPropertyDescriptors(o);\n        Object.entries(descs).forEach(([k, v]) => fn(k, v));\n        Object.getOwnPropertySymbols(descs).forEach(k => fn(k, descs[k]));\n      }",void 0,t,n).dispose()})}function f(e,t){const[n]=y(e,t);return n}function y(e,t){var n,r;const{vm:s,marshal:o,find:a,pre:l}=t;{const[t,n]=function(e,t){const n=e.typeof(t);return"undefined"===n||"number"===n||"string"===n||"boolean"===n?[e.dump(t),!0]:"object"===n&&e.unwrapResult(e.evalCode("a => a === null")).consume(n=>e.dump(e.unwrapResult(e.callFunction(n,e.undefined,t))))?[null,!0]:[void 0,!1]}(s,e);if(n)return[t,!1]}{const t=a(e);if(t)return[t,!0]}const u=e=>y(e,t),p=null!=(n=null!=(r=function(e,t,n){var r;if("symbol"!==e.typeof(t))return;const s=e.getString(e.getProp(t,"description")),o=Symbol(s);return null!=(r=n(o,t))?r:o}(s,e,l))?r:function(e,t,n,r,s){var o;if("function"!==e.typeof(t))return;const a=function(...s){const o=n(this),a=s.map(e=>n(e));if(new.target){const[n]=r(i(e,"(Cls, ...args) => new Cls(...args)",o,t,...a));return Object.defineProperties(this,Object.getOwnPropertyDescriptors(n)),this}const l=e.unwrapResult(e.callFunction(t,o,...a)),[u,p]=r(l);return p&&l.dispose(),u},l=null!=(o=s(a,t))?o:a;return h(e,t,a,r),l}(s,e,o,u,l))?n:function(e,t,n,r){var s;if("object"!==e.typeof(t)||e.unwrapResult(e.evalCode("o => o === null")).consume(n=>e.dump(e.unwrapResult(e.callFunction(n,e.undefined,t)))))return;const o=i(e,"Array.isArray",void 0,t).consume(t=>e.dump(t))?[]:{},a=null!=(s=r(o,t))?s:o,l=i(e,"o => {\n      const p = Object.getPrototypeOf(o);\n      return !p || p === Object.prototype || p === Array.prototype ? undefined : p;\n    }",void 0,t).consume(t=>{if("undefined"===e.typeof(t))return;const[r]=n(t);return r});return"object"==typeof l&&Object.setPrototypeOf(a,l),h(e,t,o,n),a}(s,e,u,l);return[p,!1]}function m(e,t){var n;return r(e)&&null!=(n=e[t])?n:e}function v(e,t,n){return _(e,t,n)?[e.getProp(t,n),!0]:[t,!1]}function _(e,t,n){return!!e.dump(i(e,'(a, s) => (typeof a === "object" && a !== null || typeof a === "function") && !!a[s]',void 0,t,n))}const g=[[Symbol,"Symbol"],[Symbol.prototype,"Symbol.prototype"],[Object,"Object"],[Object.prototype,"Object.prototype"],[Function,"Function"],[Function.prototype,"Function.prototype"],[Boolean,"Boolean"],[Boolean.prototype,"Boolean.prototype"],[Array,"Array"],[Array.prototype,"Array.prototype"],[Error,"Error"],[Error.prototype,"Error.prototype"],[EvalError,"EvalError"],[EvalError.prototype,"EvalError.prototype"],[RangeError,"RangeError"],[RangeError.prototype,"RangeError.prototype"],[ReferenceError,"ReferenceError"],[ReferenceError.prototype,"ReferenceError.prototype"],[SyntaxError,"SyntaxError"],[SyntaxError.prototype,"SyntaxError.prototype"],[TypeError,"TypeError"],[TypeError.prototype,"TypeError.prototype"],[URIError,"URIError"],[URIError.prototype,"URIError.prototype"],...Object.getOwnPropertyNames(Symbol).filter(e=>"symbol"==typeof Symbol[e]).map(e=>[Symbol[e],`Symbol.${e}`])];class b{constructor(e,n){var r;this.vm=void 0,this._map=void 0,this._registeredMap=void 0,this._registeredMapDispose=new Set,this._sync=new Set,this._temporalSync=new Set,this._symbol=Symbol(),this._symbolHandle=void 0,this._options=void 0,this.vm=e,this._options=n,this._symbolHandle=e.unwrapResult(e.evalCode("Symbol()")),this._map=new t(e),this._registeredMap=new t(e),this.registerAll(null!=(r=null==n?void 0:n.registeredObjects)?r:g)}dispose(){this._map.dispose(),this._registeredMap.dispose(),this._symbolHandle.dispose()}evalCode(e){const t=this.vm.evalCode(e);return this._unwrapResultAndUnmarshal(t)}executePendingJobs(e){const t=this.vm.executePendingJobs(e);if("value"in t)return t.value;throw t.error.consume(e=>this._unmarshal(e))}expose(e){for(const[t,n]of Object.entries(e)){const e=this._marshal(n);this.vm.setProp(this.vm.global,t,e)}}sync(e){const t=this._wrap(e);return void 0===t?e:(s(t,e=>{this._sync.add(this._unwrap(e))}),t)}register(e,t){if(this._registeredMap.has(e))return;const n="string"==typeof t?this._unwrapResult(this.vm.evalCode(t)):t;a(this.vm,n,this.vm.undefined)||("string"==typeof t&&this._registeredMapDispose.add(e),this._registeredMap.set(e,n))}registerAll(e){for(const[t,n]of e)this.register(t,n)}unregister(e,t){this._registeredMap.delete(e,this._registeredMapDispose.has(e)||t),this._registeredMapDispose.delete(e)}unregisterAll(e,t){for(const n of e)this.unregister(n,t)}startSync(e){r(e)&&this._sync.add(this._unwrap(e))}endSync(e){this._sync.delete(this._unwrap(e))}_unwrapResult(e){if("value"in e)return e.value;throw e.error.consume(e=>this._unmarshal(e))}_unwrapResultAndUnmarshal(e){if(e)return this._unwrapResult(e).consume(e=>this._unmarshal(e))}_marshal(e){var t;const n=this._registeredMap.get(e);if(n)return n;const s=d(null!=(t=this._wrap(e))?t:e,{vm:this.vm,unmarshal:e=>this._unmarshal(e),isMarshalable:e=>{var t,n;return null==(t=null==(n=this._options)||null==n.isMarshalable?void 0:n.isMarshalable(this._unwrap(e)))||t},find:e=>{var t;return null!=(t=this._registeredMap.get(e))?t:this._map.get(e)},pre:(e,t)=>{var n;return null==(n=this._register(e,t,this._map))?void 0:n[1]},preApply:(e,t,n)=>{const s=r(t)?this._unwrap(t):void 0;s&&this._temporalSync.add(s);try{return e.apply(t,n)}finally{s&&this._temporalSync.delete(s)}}});return s}_unmarshal(e){const t=this._registeredMap.getByHandle(e);if(void 0!==t)return t;const[n]=this._wrapHandle(e);return f(null!=n?n:e,{vm:this.vm,marshal:e=>this._marshal(e),find:e=>{var t;return null!=(t=this._registeredMap.getByHandle(e))?t:this._map.getByHandle(e)},pre:(e,t)=>{var n;return null==(n=this._register(e,t,void 0,!0))?void 0:n[0]}})}_register(e,t,n=this._map,r){if(this._registeredMap.has(e)||this._registeredMap.hasHandle(t))return;const s=this._wrap(e),[o]=this._wrapHandle(t);if(!s||!o)return;const i=this._unwrap(e),[a,l]=this._unwrapHandle(t);if(!n.set(s,o,i,a))throw l&&a.dispose(),new Error("already registered");return r&&this._sync.add(i),[s,o]}_syncMode(e){const t=this._unwrap(e);return this._sync.has(t)||this._temporalSync.has(t)?"both":void 0}_wrap(e){return function(e,t,n,s,o,a){if(!r(t))return;if(u=n,r(l=t)&&l[u])return t;var l,u;const p=new Proxy(t,{get:(e,t)=>t===n?e:Reflect.get(e,t),set(t,r,i,l){var u;const p=m(i,n),c=null!=(u=null==a?void 0:a(l))?u:"host";if("vm"===c||Reflect.set(t,r,p,l)){if("host"===c)return!0;const[t,n]=v(e,o(l),s);n?t.consume(t=>e.setProp(t,o(r),o(p))):e.setProp(t,o(r),o(p))}return!0},deleteProperty(t,n){var r;const l=null!=(r=null==a?void 0:a(p))?r:"host",[u,c]=v(e,o(p),s);if("vm"===l||Reflect.deleteProperty(t,n)){if("host"===l)return!0;c?u.consume(t=>i(e,"(a, b) => delete a[b]",void 0,t,o(n))):i(e,"(a, b) => delete a[b]",void 0,u,o(n))}return!0}});return p}(this.vm,e,this._symbol,this._symbolHandle,e=>this._marshal(e),e=>this._syncMode(e))}_unwrap(e){return m(e,this._symbol)}_wrapHandle(e){return function(e,t,n,r,s,o){return l(e,t)?_(e,t,r)?[t,!1]:p([e.newFunction("getSyncMode",t=>{const n=null==o?void 0:o(s(t));return"string"==typeof n?e.newString(n):e.undefined}),e.newFunction("setter",(e,t,r)=>{const o=s(e);if(!o)return;const i=s(t);if("__proto__"===i)return;const a=s(r);m(o,n)[i]=a}),e.newFunction("deleter",(e,t)=>{const r=s(e);if(!r)return;const o=s(t);delete m(r,n)[o]})],n=>[i(e,'(target, sym, getSyncMode, setter, deleter) => {\n          const rec =  new Proxy(target, {\n            get(obj, key, receiver) {\n              return key === sym ? obj : Reflect.get(obj, key, receiver)\n            },\n            set(obj, key, value, receiver) {\n              const v = typeof value === "object" && value !== null || typeof value === "function"\n                ? value[sym] ?? value\n                : value;\n              const sync = getSyncMode(receiver) ?? "vm";\n              if (sync === "host" || Reflect.set(obj, key, v, receiver)) {\n                if (sync !== "vm") {\n                  setter(receiver, key, v);\n                }\n              }\n              return true;\n            },\n            deleteProperty(obj, key) {\n              const sync = getSyncMode(rec) ?? "vm";\n              if (sync === "host" || Reflect.deleteProperty(obj, key)) {\n                if (sync !== "vm") {\n                  deleter(rec, key);\n                }\n              }\n              return true;\n            },\n          });\n          return rec;\n        }',void 0,t,r,...n),!0]):[void 0,!1]}(this.vm,e,this._symbol,this._symbolHandle,e=>this._unmarshal(e),e=>this._syncMode(e))}_unwrapHandle(e){return v(this.vm,e,this._symbolHandle)}}export{b as Arena,t as VMMap,i as call,o as complexity,p as consumeAll,g as defaultRegisteredObjects,a as eq,n as isES2015Class,l as isHandleObject,r as isObject,d as marshal,u as send,f as unmarshal,s as walkObject};
//# sourceMappingURL=quickjs-emscripten-sync.modern.js.map
