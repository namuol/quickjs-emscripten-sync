{"version":3,"file":"quickjs-emscripten-sync.module.js","sources":["../src/vmmap.ts","../src/util.ts","../src/vmutil.ts","../src/marshal/properties.ts","../src/marshal/index.ts","../src/marshal/primitive.ts","../src/marshal/symbol.ts","../src/marshal/function.ts","../src/marshal/object.ts","../src/unmarshal/properties.ts","../src/unmarshal/index.ts","../src/unmarshal/primitive.ts","../src/unmarshal/symbol.ts","../src/unmarshal/function.ts","../src/unmarshal/object.ts","../src/wrapper.ts","../src/default.ts","../src/index.ts"],"sourcesContent":["import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport default class VMMap {\n  vm: QuickJSVm;\n  _map1: Map<any, number> = new Map();\n  _map2: Map<any, number> = new Map();\n  _map3: Map<number, QuickJSHandle> = new Map();\n  _map4: Map<number, QuickJSHandle> = new Map();\n  _counterMap: Map<number, any> = new Map();\n  _disposables: Set<QuickJSHandle> = new Set();\n  _mapGet: QuickJSHandle;\n  _mapSet: QuickJSHandle;\n  _mapDelete: QuickJSHandle;\n  _mapClear: QuickJSHandle;\n  _counter = 0;\n\n  constructor(vm: QuickJSVm) {\n    this.vm = vm;\n\n    const result = vm\n      .unwrapResult(\n        vm.evalCode(`() => {\n        const mapSym = new Map();\n        let map = new WeakMap();\n        let map2 = new WeakMap();\n        const isObj = o => typeof o === \"object\" && o !== null || typeof o === \"function\";\n        return {\n          get: key => mapSym.get(key) ?? map.get(key) ?? map2.get(key) ?? -1,\n          set: (key, value, key2) => {\n            if (typeof key === \"symbol\") mapSym.set(key, value);\n            if (isObj(key)) map.set(key, value);\n            if (isObj(key2)) map2.set(key2, value);\n          },\n          delete: (key, key2) => {\n            mapSym.delete(key);\n            map.delete(key);\n            map2.delete(key2);\n          },\n          clear: () => {\n            mapSym.clear();\n            map = new WeakMap();\n            map2 = new WeakMap();\n          }\n        };\n      }`)\n      )\n      .consume((fn) => this._call(fn, undefined));\n\n    this._mapGet = vm.getProp(result, \"get\");\n    this._mapSet = vm.getProp(result, \"set\");\n    this._mapDelete = vm.getProp(result, \"delete\");\n    this._mapClear = vm.getProp(result, \"clear\");\n\n    result.dispose();\n\n    this._disposables.add(this._mapGet);\n    this._disposables.add(this._mapSet);\n    this._disposables.add(this._mapDelete);\n    this._disposables.add(this._mapClear);\n  }\n\n  set(\n    key: any,\n    handle: QuickJSHandle,\n    key2?: any,\n    handle2?: QuickJSHandle\n  ): boolean {\n    if (!handle.alive || (handle2 && !handle2.alive)) return false;\n\n    const v = this.get(key) ?? this.get(key2);\n    if (v) {\n      // handle and handle2 are unused so they should be disposed\n      return v === handle || v === handle2;\n    }\n\n    const counter = this._counter++;\n    this._map1.set(key, counter);\n    this._map3.set(counter, handle);\n    this._counterMap.set(counter, key);\n    if (key2) {\n      this._map2.set(key2, counter);\n      if (handle2) {\n        this._map4.set(counter, handle2);\n      }\n    }\n\n    this.vm.newNumber(counter).consume((c) => {\n      this._call(\n        this._mapSet,\n        undefined,\n        handle,\n        c,\n        handle2 ?? this.vm.undefined\n      );\n    });\n\n    return true;\n  }\n\n  merge(\n    iteratable:\n      | Iterable<\n          | [any, QuickJSHandle | undefined]\n          | [any, QuickJSHandle | undefined, any, QuickJSHandle | undefined]\n        >\n      | undefined\n  ) {\n    if (!iteratable) return;\n    for (const iter of iteratable) {\n      if (!iter) continue;\n      if (iter[1]) {\n        this.set(iter[0], iter[1], iter[2], iter[3]);\n      }\n    }\n  }\n\n  get(key: any) {\n    const num = this._map1.get(key) ?? this._map2.get(key);\n    const handle = typeof num === \"number\" ? this._map3.get(num) : undefined;\n\n    if (!handle) return;\n    if (!handle.alive) {\n      this.delete(key);\n      return;\n    }\n\n    return handle;\n  }\n\n  getByHandle(handle: QuickJSHandle) {\n    if (!handle.alive) {\n      return;\n    }\n    return this._counterMap.get(\n      this.vm.getNumber(this._call(this._mapGet, undefined, handle))\n    );\n  }\n\n  has(key: any) {\n    return !!this.get(key);\n  }\n\n  hasHandle(handle: QuickJSHandle) {\n    return typeof this.getByHandle(handle) !== \"undefined\";\n  }\n\n  delete(key: any, dispose?: boolean) {\n    const num = this._map1.get(key) ?? this._map2.get(key);\n    if (typeof num === \"undefined\") return;\n\n    const handle = this._map3.get(num);\n    const handle2 = this._map4.get(num);\n    this._call(\n      this._mapDelete,\n      undefined,\n      ...[handle, handle2].filter((h): h is QuickJSHandle => !!h?.alive)\n    );\n\n    this._map1.delete(key);\n    this._map2.delete(key);\n    this._map3.delete(num);\n    this._map4.delete(num);\n\n    for (const [k, v] of this._map1) {\n      if (v === num) {\n        this._map1.delete(k);\n        break;\n      }\n    }\n\n    for (const [k, v] of this._map2) {\n      if (v === num) {\n        this._map2.delete(k);\n        break;\n      }\n    }\n\n    for (const [k, v] of this._counterMap) {\n      if (v === key) {\n        this._counterMap.delete(k);\n        break;\n      }\n    }\n\n    if (dispose) {\n      if (handle?.alive) handle.dispose();\n      if (handle2?.alive) handle2.dispose();\n    }\n  }\n\n  deleteByHandle(handle: QuickJSHandle, dispose?: boolean) {\n    const key = this.getByHandle(handle);\n    if (typeof key !== \"undefined\") {\n      this.delete(key, dispose);\n    }\n  }\n\n  clear() {\n    this._counter = 0;\n    this._map1.clear();\n    this._map2.clear();\n    this._map3.clear();\n    this._map4.clear();\n    this._counterMap.clear();\n    if (this._mapClear.alive) {\n      this._call(this._mapClear, undefined);\n    }\n  }\n\n  dispose() {\n    for (const v of this._disposables.values()) {\n      if (v.alive) {\n        v.dispose();\n      }\n    }\n    for (const v of this._map3.values()) {\n      if (v.alive) {\n        v.dispose();\n      }\n    }\n    for (const v of this._map4.values()) {\n      if (v.alive) {\n        v.dispose();\n      }\n    }\n    this._disposables.clear();\n    this.clear();\n  }\n\n  get size() {\n    return this._map1.size;\n  }\n\n  [Symbol.iterator](): Iterator<\n    [any, QuickJSHandle, any, QuickJSHandle | undefined]\n  > {\n    const keys = this._map1.keys();\n    return {\n      next: () => {\n        while (true) {\n          const k1 = keys.next();\n          if (k1.done) return { value: undefined, done: true };\n          const n = this._map1.get(k1.value);\n          if (typeof n === \"undefined\") continue;\n          const v1 = this._map3.get(n);\n          const v2 = this._map4.get(n);\n          if (!v1) continue;\n          const k2 = this._get2(n);\n          return { value: [k1.value, v1, k2, v2], done: false };\n        }\n      },\n    };\n  }\n\n  _get2(num: number) {\n    for (const [k, v] of this._map2) {\n      if (v === num) return k;\n    }\n  }\n\n  _call(\n    fn: QuickJSHandle,\n    thisArg: QuickJSHandle | undefined,\n    ...args: QuickJSHandle[]\n  ) {\n    return this.vm.unwrapResult(\n      this.vm.callFunction(\n        fn,\n        typeof thisArg === \"undefined\" ? this.vm.undefined : thisArg,\n        ...args\n      )\n    );\n  }\n}\n","export function isES2015Class(cls: any): cls is new (...args: any[]) => any {\n  return (\n    typeof cls === \"function\" &&\n    /^class\\s/.test(Function.prototype.toString.call(cls))\n  );\n}\n\nexport function isObject(value: any): value is object | Function {\n  return (\n    typeof value === \"function\" || (typeof value === \"object\" && value !== null)\n  );\n}\n\nexport function walkObject(\n  value: any,\n  callback?: (target: any, set: Set<any>) => boolean | void\n): Set<any> {\n  const set = new Set<any>();\n  const walk = (v: any) => {\n    if (!isObject(v) || set.has(v) || callback?.(v, set) === false) return;\n    set.add(v);\n\n    if (Array.isArray(v)) {\n      for (const e of v) {\n        walk(e);\n      }\n      return;\n    }\n\n    if (typeof v === \"object\") {\n      const proto = Object.getPrototypeOf(v);\n      if (proto && proto !== Object.prototype) {\n        walk(proto);\n      }\n    }\n\n    for (const d of Object.values(Object.getOwnPropertyDescriptors(v))) {\n      if (\"value\" in d) walk(d.value);\n      if (\"get\" in d) walk(d.get);\n      if (\"set\" in d) walk(d.set);\n    }\n  };\n\n  walk(value);\n  return set;\n}\n\n/**\n * Measure the complexity of an object as you traverse the field and prototype chain. If max is specified, when the complexity reaches max, the traversal is terminated and it returns the max. In this function, one object and function are counted as a complexity of 1, and primitives are not counted as a complexity.\n */\nexport function complexity(value: any, max?: number): number {\n  return walkObject(value, max ? (_, set) => set.size < max : undefined).size;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport function call(\n  vm: QuickJSVm,\n  code: string,\n  thisArg?: QuickJSHandle,\n  ...args: QuickJSHandle[]\n): QuickJSHandle {\n  return vm.unwrapResult(vm.evalCode(code)).consume((f) => {\n    if (typeof thisArg === \"undefined\" && args.length === 0) return f;\n    return vm.unwrapResult(\n      vm.callFunction(f, thisArg ?? vm.undefined, ...args)\n    );\n  });\n}\n\nexport function eq(vm: QuickJSVm, a: QuickJSHandle, b: QuickJSHandle): boolean {\n  return vm.dump(call(vm, \"Object.is\", undefined, a, b));\n}\n\nexport function instanceOf(\n  vm: QuickJSVm,\n  a: QuickJSHandle,\n  b: QuickJSHandle\n): boolean {\n  return vm.dump(call(vm, \"(a, b) => a instanceof b\", undefined, a, b));\n}\n\nexport function isHandleObject(vm: QuickJSVm, a: QuickJSHandle): boolean {\n  return vm.dump(\n    call(\n      vm,\n      `a => typeof a === \"object\" && a !== null || typeof a === \"function\"`,\n      undefined,\n      a\n    )\n  );\n}\n\nexport function send(vm: QuickJSVm, target: any): QuickJSHandle {\n  const json = JSON.stringify(target);\n  if (!json) return vm.undefined;\n  return call(vm, `JSON.parse`, undefined, vm.newString(json));\n}\n\nexport function consumeAll<T extends QuickJSHandle[], K>(\n  handles: T,\n  cb: (handles: T) => K\n): K {\n  try {\n    return cb(handles);\n  } finally {\n    for (const h of handles) {\n      if (h.alive) h.dispose();\n    }\n  }\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\n\nexport default function marshalProperties(\n  vm: QuickJSVm,\n  target: object | Function,\n  handle: QuickJSHandle,\n  marshal: (target: unknown) => QuickJSHandle\n): void {\n  const descs = vm.newObject();\n  const cb = (key: string | number | symbol, desc: PropertyDescriptor) => {\n    const keyHandle = marshal(key);\n    const valueHandle =\n      typeof desc.value === \"undefined\" ? undefined : marshal(desc.value);\n    const getHandle =\n      typeof desc.get === \"undefined\" ? undefined : marshal(desc.get);\n    const setHandle =\n      typeof desc.set === \"undefined\" ? undefined : marshal(desc.set);\n\n    vm.newObject().consume((descObj) => {\n      Object.entries(desc).forEach(([k, v]) => {\n        const v2 =\n          k === \"value\"\n            ? valueHandle\n            : k === \"get\"\n            ? getHandle\n            : k === \"set\"\n            ? setHandle\n            : v\n            ? vm.true\n            : vm.false;\n        if (v2) {\n          vm.setProp(descObj, k, v2);\n        }\n      });\n      vm.setProp(descs, keyHandle, descObj);\n    });\n  };\n\n  const desc = Object.getOwnPropertyDescriptors(target);\n  Object.entries(desc).forEach(([k, v]) => cb(k, v));\n  Object.getOwnPropertySymbols(desc).forEach((k) => cb(k, (desc as any)[k]));\n\n  call(vm, `Object.defineProperties`, undefined, handle, descs).dispose();\n\n  descs.dispose();\n}\n","import { QuickJSHandle, QuickJSVm } from \"quickjs-emscripten\";\nimport marshalFunction from \"./function\";\nimport marshalObject from \"./object\";\nimport marshalPrimitive from \"./primitive\";\nimport marshalSymbol from \"./symbol\";\n\nexport type Options = {\n  vm: QuickJSVm;\n  unmarshal: (handle: QuickJSHandle) => unknown;\n  isMarshalable?: (target: unknown) => boolean;\n  find: (target: unknown) => QuickJSHandle | undefined;\n  pre: (target: unknown, handle: QuickJSHandle) => QuickJSHandle | undefined;\n  preApply?: (target: Function, thisArg: unknown, args: unknown[]) => any;\n};\n\nexport function marshal(target: unknown, options: Options): QuickJSHandle {\n  const { vm, unmarshal, isMarshalable, find, pre } = options;\n\n  {\n    const primitive = marshalPrimitive(vm, target);\n    if (primitive) {\n      return primitive;\n    }\n  }\n\n  {\n    const handle = find(target);\n    if (handle) return handle;\n  }\n\n  if (isMarshalable?.(target) === false) {\n    return vm.undefined;\n  }\n\n  const marshal2 = (t: unknown) => marshal(t, options);\n\n  const result =\n    marshalSymbol(vm, target, pre) ??\n    marshalFunction(vm, target, marshal2, unmarshal, pre, options.preApply) ??\n    marshalObject(vm, target, marshal2, pre) ??\n    vm.undefined;\n\n  return result;\n}\n\nexport default marshal;\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n// import { call } from \"../vmutil\";\n\nexport default function marshalPrimitive(\n  vm: QuickJSVm,\n  target: unknown\n): QuickJSHandle | undefined {\n  switch (typeof target) {\n    case \"undefined\":\n      return vm.undefined;\n    case \"number\":\n      return vm.newNumber(target);\n    case \"string\":\n      return vm.newString(target);\n    case \"boolean\":\n      return target ? vm.true : vm.false;\n    case \"object\":\n      return target === null ? vm.null : undefined;\n\n    // BigInt is not supported by quickjs-emscripten\n    // case \"bigint\":\n    //   return call(\n    //     vm,\n    //     `s => BigInt(s)`,\n    //     undefined,\n    //     vm.newString(target.toString())\n    //   );\n  }\n\n  return undefined;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\n\nexport default function marshalSymbol(\n  vm: QuickJSVm,\n  target: unknown,\n  preMarshal: (\n    target: unknown,\n    handle: QuickJSHandle\n  ) => QuickJSHandle | undefined\n): QuickJSHandle | undefined {\n  if (typeof target !== \"symbol\") return;\n  const handle = call(\n    vm,\n    \"d => Symbol(d)\",\n    undefined,\n    target.description ? vm.newString(target.description) : vm.undefined\n  );\n  return preMarshal(target, handle) ?? handle;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { isES2015Class, isObject } from \"../util\";\nimport { call } from \"../vmutil\";\nimport marshalProperties from \"./properties\";\n\nexport default function marshalFunction(\n  vm: QuickJSVm,\n  target: unknown,\n  marshal: (target: unknown) => QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => unknown,\n  preMarshal: (\n    target: unknown,\n    handle: QuickJSHandle\n  ) => QuickJSHandle | undefined,\n  preApply?: (target: Function, thisArg: unknown, args: unknown[]) => any\n): QuickJSHandle | undefined {\n  if (typeof target !== \"function\") return;\n\n  const raw = vm\n    .newFunction(target.name, function (...argHandles) {\n      const that = unmarshal(this);\n      const args = argHandles.map((a) => unmarshal(a));\n\n      if (isES2015Class(target) && isObject(that)) {\n        // Class constructors cannot be invoked without new expression, and new.target is not changed\n        const result = new target(...args);\n        Object.entries(result).forEach(([key, value]) => {\n          vm.setProp(this, key, marshal(value));\n        });\n        return this;\n      }\n\n      return marshal(\n        preApply ? preApply(target, that, args) : target.apply(that, args)\n      );\n    })\n    .consume((handle2) =>\n      // fucntions created by vm.newFunction are not callable as a class constrcutor\n      call(\n        vm,\n        `Cls => {\n          const fn = function(...args) { return Cls.apply(this, args); };\n          fn.name = Cls.name;\n          fn.length = Cls.length;\n          return fn;\n        }`,\n        undefined,\n        handle2\n      )\n    );\n\n  const handle = preMarshal(target, raw) ?? raw;\n  marshalProperties(vm, target, raw, marshal);\n\n  return handle;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\nimport marshalProperties from \"./properties\";\n\nexport default function marshalObject(\n  vm: QuickJSVm,\n  target: unknown,\n  marshal: (target: unknown) => QuickJSHandle,\n  preMarshal: (\n    target: unknown,\n    handle: QuickJSHandle\n  ) => QuickJSHandle | undefined\n): QuickJSHandle | undefined {\n  if (typeof target !== \"object\" || target === null) return;\n\n  const raw = Array.isArray(target) ? vm.newArray() : vm.newObject();\n  const handle = preMarshal(target, raw) ?? raw;\n\n  // prototype\n  const prototype = Object.getPrototypeOf(target);\n  const prototypeHandle =\n    prototype && prototype !== Object.prototype && prototype !== Array.prototype\n      ? marshal(prototype)\n      : undefined;\n  if (prototypeHandle) {\n    call(\n      vm,\n      \"Object.setPrototypeOf\",\n      undefined,\n      handle,\n      prototypeHandle\n    ).dispose();\n  }\n\n  marshalProperties(vm, target, raw, marshal);\n\n  return handle;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\n\nexport default function unmarshalProperties(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  target: object | Function,\n  unmarshal: (handle: QuickJSHandle) => [unknown, boolean]\n) {\n  vm.newFunction(\"\", (key, value) => {\n    const [keyName] = unmarshal(key);\n    if (\n      typeof keyName !== \"string\" &&\n      typeof keyName !== \"number\" &&\n      typeof keyName !== \"symbol\"\n    )\n      return;\n\n    const desc = (\n      [\n        [\"value\", true],\n        [\"get\", true],\n        [\"set\", true],\n        [\"configurable\", false],\n        [\"enumerable\", false],\n        [\"writable\", false],\n      ] as const\n    ).reduce<PropertyDescriptor>((desc, [key, unmarshable]) => {\n      const h = vm.getProp(value, key);\n      const ty = vm.typeof(h);\n\n      if (ty === \"undefined\") return desc;\n      if (!unmarshable && ty === \"boolean\") {\n        desc[key] = vm.dump(vm.getProp(value, key));\n        return desc;\n      }\n\n      const [v, alreadyExists] = unmarshal(h);\n      if (alreadyExists) {\n        h.dispose();\n      }\n      desc[key] = v;\n\n      return desc;\n    }, {});\n\n    Object.defineProperty(target, keyName, desc);\n  }).consume((fn) => {\n    call(\n      vm,\n      `(o, fn) => {\n        const descs = Object.getOwnPropertyDescriptors(o);\n        Object.entries(descs).forEach(([k, v]) => fn(k, v));\n        Object.getOwnPropertySymbols(descs).forEach(k => fn(k, descs[k]));\n      }`,\n      undefined,\n      handle,\n      fn\n    ).dispose();\n  });\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport unmarshalFunction from \"./function\";\nimport unmarshalObject from \"./object\";\nimport unmarshalPrimitive from \"./primitive\";\nimport unmarshalSymbol from \"./symbol\";\n\nexport type Options = {\n  vm: QuickJSVm;\n  marshal: (target: unknown) => QuickJSHandle;\n  find: (handle: QuickJSHandle) => unknown | undefined;\n  pre: <T>(target: T, handle: QuickJSHandle) => T | undefined;\n};\n\nexport function unmarshal(handle: QuickJSHandle, options: Options): any {\n  const [result] = unmarshalInner(handle, options);\n  return result;\n}\n\nfunction unmarshalInner(\n  handle: QuickJSHandle,\n  options: Options\n): [any, boolean] {\n  const { vm, marshal, find, pre } = options;\n\n  {\n    const [target, ok] = unmarshalPrimitive(vm, handle);\n    if (ok) return [target, false];\n  }\n\n  {\n    const target = find(handle);\n    if (target) {\n      return [target, true];\n    }\n  }\n\n  const unmarshal2 = (h: QuickJSHandle) => unmarshalInner(h, options);\n\n  const result =\n    unmarshalSymbol(vm, handle, pre) ??\n    unmarshalFunction(vm, handle, marshal, unmarshal2, pre) ??\n    unmarshalObject(vm, handle, unmarshal2, pre);\n\n  return [result, false];\n}\n\nexport default unmarshal;\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport default function unmarshalPrimitive(\n  vm: QuickJSVm,\n  handle: QuickJSHandle\n): [any, boolean] {\n  const ty = vm.typeof(handle);\n  if (\n    ty === \"undefined\" ||\n    ty === \"number\" ||\n    ty === \"string\" ||\n    ty === \"boolean\"\n  ) {\n    return [vm.dump(handle), true];\n  } else if (ty === \"object\") {\n    const isNull = vm\n      .unwrapResult(vm.evalCode(\"a => a === null\"))\n      .consume((n) =>\n        vm.dump(vm.unwrapResult(vm.callFunction(n, vm.undefined, handle)))\n      );\n    if (isNull) {\n      return [null, true];\n    }\n  }\n\n  // BigInt is not supported by quickjs-emscripten\n  // if (ty === \"bigint\") {\n  //   const str = vm\n  //     .getProp(handle, \"toString\")\n  //     .consume(toString => vm.unwrapResult(vm.callFunction(toString, handle)))\n  //     .consume(str => vm.getString(str));\n  //   const bi = BigInt(str);\n  //   return [bi, true];\n  // }\n\n  return [undefined, false];\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\n\nexport default function unmarshalSymbol(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  preUnmarshal: <T>(target: T, handle: QuickJSHandle) => T | undefined\n): symbol | undefined {\n  if (vm.typeof(handle) !== \"symbol\") return;\n  const desc = vm.getString(vm.getProp(handle, \"description\"));\n  const sym = Symbol(desc);\n  return preUnmarshal(sym, handle) ?? sym;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { call } from \"../vmutil\";\nimport unmarshalProperties from \"./properties\";\n\nexport default function unmarshalFunction(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  marshal: (value: unknown) => QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => [unknown, boolean],\n  preUnmarshal: <T>(target: T, handle: QuickJSHandle) => T | undefined\n): Function | undefined {\n  if (vm.typeof(handle) !== \"function\") return;\n\n  const raw = function (this: any, ...args: any[]) {\n    const thisHandle = marshal(this);\n    const argHandles = args.map((a) => marshal(a));\n\n    if (new.target) {\n      const [instance] = unmarshal(\n        call(\n          vm,\n          `(Cls, ...args) => new Cls(...args)`,\n          thisHandle,\n          handle,\n          ...argHandles\n        )\n      );\n      Object.defineProperties(this, Object.getOwnPropertyDescriptors(instance));\n      return this;\n    }\n\n    const resultHandle = vm.unwrapResult(\n      vm.callFunction(handle, thisHandle, ...argHandles)\n    );\n    const [result, alreadyExists] = unmarshal(resultHandle);\n    if (alreadyExists) resultHandle.dispose();\n    return result;\n  };\n\n  const func = preUnmarshal(raw, handle) ?? raw;\n  unmarshalProperties(vm, handle, raw, unmarshal);\n\n  return func;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport unmarshalProperties from \"./properties\";\nimport { call } from \"../vmutil\";\n\nexport default function unmarshalObject(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => [unknown, boolean],\n  preUnmarshal: <T>(target: T, handle: QuickJSHandle) => T | undefined\n): object | undefined {\n  if (\n    vm.typeof(handle) !== \"object\" ||\n    // null check\n    vm\n      .unwrapResult(vm.evalCode(\"o => o === null\"))\n      .consume((n) =>\n        vm.dump(vm.unwrapResult(vm.callFunction(n, vm.undefined, handle)))\n      )\n  )\n    return;\n\n  const raw = call(vm, \"Array.isArray\", undefined, handle).consume((r) =>\n    vm.dump(r)\n  )\n    ? []\n    : {};\n  const obj = preUnmarshal(raw, handle) ?? raw;\n\n  const prototype = call(\n    vm,\n    `o => {\n      const p = Object.getPrototypeOf(o);\n      return !p || p === Object.prototype || p === Array.prototype ? undefined : p;\n    }`,\n    undefined,\n    handle\n  ).consume((prototype) => {\n    if (vm.typeof(prototype) === \"undefined\") return;\n    const [proto] = unmarshal(prototype);\n    return proto;\n  });\n  if (typeof prototype === \"object\") {\n    Object.setPrototypeOf(obj, prototype);\n  }\n\n  unmarshalProperties(vm, handle, raw, unmarshal);\n\n  return obj;\n}\n","import { QuickJSVm, QuickJSHandle } from \"quickjs-emscripten\";\nimport { isObject } from \"./util\";\nimport { call, isHandleObject, consumeAll } from \"./vmutil\";\n\nexport type SyncMode = \"both\" | \"vm\" | \"host\";\n\nexport type Wrapped<T> = T & { __qes_wrapped: never };\n\nexport function wrap<T = any>(\n  vm: QuickJSVm,\n  target: T,\n  proxyKeySymbol: symbol,\n  proxyKeySymbolHandle: QuickJSHandle,\n  marshal: (target: any) => QuickJSHandle,\n  syncMode?: (target: T) => SyncMode | undefined\n): Wrapped<T> | undefined {\n  if (!isObject(target)) return undefined;\n  if (isWrapped(target, proxyKeySymbol)) return target;\n\n  const rec = new Proxy(target as any, {\n    get(obj, key) {\n      return key === proxyKeySymbol ? obj : Reflect.get(obj, key);\n    },\n    set(obj, key, value, receiver) {\n      const v = unwrap(value, proxyKeySymbol);\n      const sync = syncMode?.(receiver) ?? \"host\";\n      if (sync === \"vm\" || Reflect.set(obj, key, v, receiver)) {\n        if (sync === \"host\") return true;\n        const [handle2, unwrapped] = unwrapHandle(\n          vm,\n          marshal(receiver),\n          proxyKeySymbolHandle\n        );\n        if (unwrapped) {\n          handle2.consume((h) => vm.setProp(h, marshal(key), marshal(v)));\n        } else {\n          vm.setProp(handle2, marshal(key), marshal(v));\n        }\n      }\n      return true;\n    },\n    deleteProperty(obj, key) {\n      const sync = syncMode?.(rec) ?? \"host\";\n      const [handle2, unwrapped] = unwrapHandle(\n        vm,\n        marshal(rec),\n        proxyKeySymbolHandle\n      );\n      if (sync === \"vm\" || Reflect.deleteProperty(obj, key)) {\n        if (sync === \"host\") return true;\n        if (unwrapped) {\n          handle2.consume((h) =>\n            call(vm, `(a, b) => delete a[b]`, undefined, h, marshal(key))\n          );\n        } else {\n          call(vm, `(a, b) => delete a[b]`, undefined, handle2, marshal(key));\n        }\n      }\n      return true;\n    },\n  }) as Wrapped<T>;\n  return rec;\n}\n\nexport function wrapHandle(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  proxyKeySymbol: symbol,\n  proxyKeySymbolHandle: QuickJSHandle,\n  unmarshal: (handle: QuickJSHandle) => any,\n  syncMode?: (target: QuickJSHandle) => SyncMode | undefined\n): [Wrapped<QuickJSHandle> | undefined, boolean] {\n  if (!isHandleObject(vm, handle)) return [undefined, false];\n  if (isHandleWrapped(vm, handle, proxyKeySymbolHandle)) return [handle, false];\n\n  return consumeAll(\n    [\n      vm.newFunction(\"getSyncMode\", (h) => {\n        const res = syncMode?.(unmarshal(h));\n        if (typeof res === \"string\") return vm.newString(res);\n        return vm.undefined;\n      }),\n      vm.newFunction(\"setter\", (h, keyHandle, valueHandle) => {\n        const target = unmarshal(h);\n        if (!target) return;\n        const key = unmarshal(keyHandle);\n        if (key === \"__proto__\") return; // for security\n        const value = unmarshal(valueHandle);\n        unwrap(target, proxyKeySymbol)[key] = value;\n      }),\n      vm.newFunction(\"deleter\", (h, keyHandle) => {\n        const target = unmarshal(h);\n        if (!target) return;\n        const key = unmarshal(keyHandle);\n        delete unwrap(target, proxyKeySymbol)[key];\n      }),\n    ],\n    (args) => [\n      call(\n        vm,\n        `(target, sym, getSyncMode, setter, deleter) => {\n          const rec =  new Proxy(target, {\n            get(obj, key, receiver) {\n              return key === sym ? obj : Reflect.get(obj, key, receiver)\n            },\n            set(obj, key, value, receiver) {\n              const v = typeof value === \"object\" && value !== null || typeof value === \"function\"\n                ? value[sym] ?? value\n                : value;\n              const sync = getSyncMode(receiver) ?? \"vm\";\n              if (sync === \"host\" || Reflect.set(obj, key, v, receiver)) {\n                if (sync !== \"vm\") {\n                  setter(receiver, key, v);\n                }\n              }\n              return true;\n            },\n            deleteProperty(obj, key) {\n              const sync = getSyncMode(rec) ?? \"vm\";\n              if (sync === \"host\" || Reflect.deleteProperty(obj, key)) {\n                if (sync !== \"vm\") {\n                  deleter(rec, key);\n                }\n              }\n              return true;\n            },\n          });\n          return rec;\n        }`,\n        undefined,\n        handle,\n        proxyKeySymbolHandle,\n        ...args\n      ) as Wrapped<QuickJSHandle>,\n      true,\n    ]\n  );\n}\n\nexport function unwrap<T>(obj: T, key: string | symbol): T {\n  return isObject(obj) ? ((obj as any)[key] as T) ?? obj : obj;\n}\n\nexport function unwrapHandle(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  key: QuickJSHandle\n): [QuickJSHandle, boolean] {\n  if (!isHandleWrapped(vm, handle, key)) return [handle, false];\n  return [vm.getProp(handle, key), true];\n}\n\nexport function isWrapped<T>(obj: T, key: string | symbol): obj is Wrapped<T> {\n  return isObject(obj) && !!(obj as any)[key];\n}\n\nexport function isHandleWrapped(\n  vm: QuickJSVm,\n  handle: QuickJSHandle,\n  key: QuickJSHandle\n): handle is Wrapped<QuickJSHandle> {\n  return !!vm.dump(\n    call(\n      vm,\n      `(a, s) => (typeof a === \"object\" && a !== null || typeof a === \"function\") && !!a[s]`,\n      undefined,\n      handle,\n      key\n    )\n  );\n}\n","/**\n * Default value of registeredObjects option of the Arena class constructor.\n */\nexport const defaultRegisteredObjects: [any, string][] = [\n  // basic objects\n  [Symbol, \"Symbol\"],\n  [Symbol.prototype, \"Symbol.prototype\"],\n  [Object, \"Object\"],\n  [Object.prototype, \"Object.prototype\"],\n  [Function, \"Function\"],\n  [Function.prototype, \"Function.prototype\"],\n  [Boolean, \"Boolean\"],\n  [Boolean.prototype, \"Boolean.prototype\"],\n  [Array, \"Array\"],\n  [Array.prototype, \"Array.prototype\"],\n  // [BigInt, \"BigInt\"],\n  // [BigInt.prototype, \"BigInt.prototype\"],\n  // errors\n  [Error, \"Error\"],\n  [Error.prototype, \"Error.prototype\"],\n  [EvalError, \"EvalError\"],\n  [EvalError.prototype, \"EvalError.prototype\"],\n  [RangeError, \"RangeError\"],\n  [RangeError.prototype, \"RangeError.prototype\"],\n  [ReferenceError, \"ReferenceError\"],\n  [ReferenceError.prototype, \"ReferenceError.prototype\"],\n  [SyntaxError, \"SyntaxError\"],\n  [SyntaxError.prototype, \"SyntaxError.prototype\"],\n  [TypeError, \"TypeError\"],\n  [TypeError.prototype, \"TypeError.prototype\"],\n  [URIError, \"URIError\"],\n  [URIError.prototype, \"URIError.prototype\"],\n  // built-in symbols\n  ...Object.getOwnPropertyNames(Symbol)\n    .filter((k) => typeof (Symbol as any)[k] === \"symbol\")\n    .map<[any, string]>((k) => [(Symbol as any)[k], `Symbol.${k}`]),\n];\n","import { QuickJSHandle, QuickJSVm } from \"quickjs-emscripten\";\nimport {\n  SuccessOrFail,\n  VmCallResult,\n} from \"quickjs-emscripten/dist/vm-interface\";\n\nimport VMMap from \"./vmmap\";\nimport marshal from \"./marshal\";\nimport unmarshal from \"./unmarshal\";\nimport { wrap, wrapHandle, unwrap, unwrapHandle, Wrapped } from \"./wrapper\";\nimport { complexity, isES2015Class, isObject, walkObject } from \"./util\";\nimport { call, eq, isHandleObject, send, consumeAll } from \"./vmutil\";\nimport { defaultRegisteredObjects } from \"./default\";\n\nexport {\n  VMMap,\n  defaultRegisteredObjects,\n  marshal,\n  unmarshal,\n  complexity,\n  isES2015Class,\n  isObject,\n  walkObject,\n  call,\n  eq,\n  isHandleObject,\n  send,\n  consumeAll,\n};\n\nexport type Options = {\n  /** A callback that returns a boolean value that determines whether an object is marshalled or not. If false, no marshaling will be done and undefined will be passed to the QuickJS VM, otherwise marshaling will be done. By default, all objects will be marshalled. */\n  isMarshalable?: (target: any) => boolean;\n  /** You can pre-register a pair of objects that will be considered the same between the host and the QuickJS VM. This will be used automatically during the conversion. By default, it will be registered automatically with `defaultRegisteredObjects`.\n   *\n   * Instead of a string, you can also pass a QuickJSHandle directly. In that case, however, you have to dispose of them manually when destroying the VM.\n   */\n  registeredObjects?: Iterable<[any, QuickJSHandle | string]>;\n};\n\n/**\n * The Arena class manages all generated handles at once by quickjs-emscripten and automatically converts objects between the host and the QuickJS VM.\n */\nexport class Arena {\n  vm: QuickJSVm;\n  _map: VMMap;\n  _registeredMap: VMMap;\n  _registeredMapDispose: Set<any> = new Set();\n  _sync: Set<any> = new Set();\n  _temporalSync: Set<any> = new Set();\n  _symbol = Symbol();\n  _symbolHandle: QuickJSHandle;\n  _options?: Options;\n\n  /** Constructs a new Arena instance. It requires a quickjs-emscripten VM initialized with `quickjs.createVM()`. */\n  constructor(vm: QuickJSVm, options?: Options) {\n    this.vm = vm;\n    this._options = options;\n    this._symbolHandle = vm.unwrapResult(vm.evalCode(`Symbol()`));\n    this._map = new VMMap(vm);\n    this._registeredMap = new VMMap(vm);\n    this.registerAll(options?.registeredObjects ?? defaultRegisteredObjects);\n  }\n\n  /**\n   * Dispose of the arena and managed handles. This method won't dispose the VM itself, so the VM has to be disposed of manually.\n   */\n  dispose() {\n    this._map.dispose();\n    this._registeredMap.dispose();\n    this._symbolHandle.dispose();\n  }\n\n  /**\n   * Evaluate JS code in the VM and get the result as an object on the host side. It also converts and re-throws error objects when an error is thrown during evaluation.\n   */\n  evalCode<T = any>(code: string): T {\n    const handle = this.vm.evalCode(code);\n    return this._unwrapResultAndUnmarshal(handle);\n  }\n\n  /**\n   * Almost same as `vm.executePendingJobs()`, but it converts and re-throws error objects when an error is thrown during evaluation.\n   */\n  executePendingJobs(maxJobsToExecute?: number): number {\n    const result = this.vm.executePendingJobs(maxJobsToExecute);\n    if (\"value\" in result) {\n      return result.value;\n    }\n    throw result.error.consume((err) => this._unmarshal(err));\n  }\n\n  /**\n   * Expose objects as global objects in the VM.\n   *\n   * By default, exposed objects are not synchronized between the host and the VM.\n   * If you want to sync an objects, first wrap the object with sync method, and then expose the wrapped object.\n   */\n  expose(obj: { [k: string]: any }) {\n    for (const [key, value] of Object.entries(obj)) {\n      const handle = this._marshal(value);\n      this.vm.setProp(this.vm.global, key, handle);\n    }\n  }\n\n  /**\n   * Enables sync for the object between the host and the VM and returns objects wrapped with proxies.\n   *\n   * The return value is necessary in order to reflect changes to the object from the host to the VM. Please note that setting a value in the field or deleting a field in the original object will not synchronize it.\n   */\n  sync<T>(target: T): T {\n    const wrapped = this._wrap(target);\n    if (typeof wrapped === \"undefined\") return target;\n    walkObject(wrapped, (v) => {\n      this._sync.add(this._unwrap(v));\n    });\n    return wrapped;\n  }\n\n  /**\n   * Register a pair of objects that will be considered the same between the host and the QuickJS VM.\n   *\n   * Instead of a string, you can also pass a QuickJSHandle directly. In that case, however, when  you have to dispose them manually when destroying the VM.\n   */\n  register(target: any, handleOrCode: QuickJSHandle | string) {\n    if (this._registeredMap.has(target)) return;\n    const handle =\n      typeof handleOrCode === \"string\"\n        ? this._unwrapResult(this.vm.evalCode(handleOrCode))\n        : handleOrCode;\n    if (eq(this.vm, handle, this.vm.undefined)) return;\n    if (typeof handleOrCode === \"string\") {\n      this._registeredMapDispose.add(target);\n    }\n    this._registeredMap.set(target, handle);\n  }\n\n  /**\n   * Execute `register` methods for each pair.\n   */\n  registerAll(map: Iterable<[any, QuickJSHandle | string]>) {\n    for (const [k, v] of map) {\n      this.register(k, v);\n    }\n  }\n\n  /**\n   * Unregister a pair of objects that were registered with `registeredObjects` option and `register` method.\n   */\n  unregister(target: any, dispose?: boolean) {\n    this._registeredMap.delete(\n      target,\n      this._registeredMapDispose.has(target) || dispose\n    );\n    this._registeredMapDispose.delete(target);\n  }\n\n  /**\n   * Execute `unregister` methods for each target.\n   */\n  unregisterAll(targets: Iterable<any>, dispose?: boolean) {\n    for (const t of targets) {\n      this.unregister(t, dispose);\n    }\n  }\n\n  startSync(target: any) {\n    if (!isObject(target)) return;\n    this._sync.add(this._unwrap(target));\n  }\n\n  endSync(target: any) {\n    this._sync.delete(this._unwrap(target));\n  }\n\n  _unwrapResult<T>(result: SuccessOrFail<T, QuickJSHandle>): T {\n    if (\"value\" in result) {\n      return result.value;\n    }\n    throw result.error.consume((err) => this._unmarshal(err));\n  }\n\n  _unwrapResultAndUnmarshal(\n    result: VmCallResult<QuickJSHandle> | undefined\n  ): any {\n    if (!result) return;\n    return this._unwrapResult(result).consume((h) => this._unmarshal(h));\n  }\n\n  _marshal(target: any): QuickJSHandle {\n    const registered = this._registeredMap.get(target);\n    if (registered) {\n      return registered;\n    }\n\n    const handle = marshal(this._wrap(target) ?? target, {\n      vm: this.vm,\n      unmarshal: (h) => this._unmarshal(h),\n      isMarshalable: (t) =>\n        this._options?.isMarshalable?.(this._unwrap(t)) ?? true,\n      find: (t) => this._registeredMap.get(t) ?? this._map.get(t),\n      pre: (t, h) => this._register(t, h, this._map)?.[1],\n      preApply: (target, that, args) => {\n        const unwrapped = isObject(that) ? this._unwrap(that) : undefined;\n        // override sync mode of this object while calling the function\n        if (unwrapped) this._temporalSync.add(unwrapped);\n        try {\n          return target.apply(that, args);\n        } finally {\n          // restore sync mode\n          if (unwrapped) this._temporalSync.delete(unwrapped);\n        }\n      },\n    });\n\n    return handle;\n  }\n\n  _unmarshal(handle: QuickJSHandle): any {\n    const registered = this._registeredMap.getByHandle(handle);\n    if (typeof registered !== \"undefined\") {\n      return registered;\n    }\n\n    const [wrappedHandle] = this._wrapHandle(handle);\n    return unmarshal(wrappedHandle ?? handle, {\n      vm: this.vm,\n      marshal: (v: any) => this._marshal(v),\n      find: (h) =>\n        this._registeredMap.getByHandle(h) ?? this._map.getByHandle(h),\n      pre: (t: any, h: QuickJSHandle) =>\n        this._register(t, h, undefined, true)?.[0],\n    });\n  }\n\n  _register(\n    t: any,\n    h: QuickJSHandle,\n    map: VMMap = this._map,\n    sync?: boolean\n  ): [Wrapped<any>, Wrapped<QuickJSHandle>] | undefined {\n    if (this._registeredMap.has(t) || this._registeredMap.hasHandle(h)) {\n      return;\n    }\n\n    const wrappedT = this._wrap(t);\n    const [wrappedH] = this._wrapHandle(h);\n    if (!wrappedT || !wrappedH) return; // t or h is not an object\n\n    const unwrappedT = this._unwrap(t);\n    const [unwrappedH, unwrapped] = this._unwrapHandle(h);\n\n    const res = map.set(wrappedT, wrappedH, unwrappedT, unwrappedH);\n    if (!res) {\n      // already registered\n      if (unwrapped) unwrappedH.dispose();\n      throw new Error(\"already registered\");\n    } else if (sync) {\n      this._sync.add(unwrappedT);\n    }\n\n    return [wrappedT, wrappedH];\n  }\n\n  _syncMode(obj: any) {\n    const obj2 = this._unwrap(obj);\n    return this._sync.has(obj2) || this._temporalSync.has(obj2)\n      ? \"both\"\n      : undefined;\n  }\n\n  _wrap<T>(target: T): Wrapped<T> | undefined {\n    return wrap(\n      this.vm,\n      target,\n      this._symbol,\n      this._symbolHandle,\n      (t) => this._marshal(t),\n      (t) => this._syncMode(t)\n    );\n  }\n\n  _unwrap<T>(target: T): T {\n    return unwrap(target, this._symbol);\n  }\n\n  _wrapHandle(\n    handle: QuickJSHandle\n  ): [Wrapped<QuickJSHandle> | undefined, boolean] {\n    return wrapHandle(\n      this.vm,\n      handle,\n      this._symbol,\n      this._symbolHandle,\n      (h) => this._unmarshal(h),\n      (t) => this._syncMode(t)\n    );\n  }\n\n  _unwrapHandle(target: QuickJSHandle): [QuickJSHandle, boolean] {\n    return unwrapHandle(this.vm, target, this._symbolHandle);\n  }\n}\n"],"names":["VMMap","vm","_map1","Map","_map2","_map3","_map4","_counterMap","_disposables","Set","_mapGet","_mapSet","_mapDelete","_mapClear","_counter","this","result","unwrapResult","evalCode","consume","fn","_this","_call","undefined","getProp","dispose","add","set","key","handle","key2","handle2","alive","v","get","counter","newNumber","c","_this2","merge","iteratable","iter","num","getByHandle","getNumber","has","hasHandle","filter","h","deleteByHandle","clear","values","keys","next","k1","done","value","n","_this3","v1","v2","k2","_get2","thisArg","callFunction","size","Symbol","iterator","isES2015Class","cls","test","Function","prototype","toString","call","isObject","walkObject","callback","walk","Array","isArray","proto","Object","getPrototypeOf","getOwnPropertyDescriptors","d","complexity","max","_","code","args","f","length","eq","a","b","dump","isHandleObject","send","target","json","JSON","stringify","newString","consumeAll","handles","cb","marshalProperties","marshal","descs","newObject","desc","keyHandle","valueHandle","getHandle","setHandle","descObj","entries","forEach","k","setProp","getOwnPropertySymbols","options","unmarshal","isMarshalable","find","pre","primitive","marshalPrimitive","marshal2","t","preMarshal","description","marshalSymbol","preApply","raw","newFunction","name","that","map","apply","marshalFunction","newArray","prototypeHandle","marshalObject","unmarshalProperties","keyName","reduce","unmarshable","ty","defineProperty","unmarshalInner","unmarshalPrimitive","unmarshal2","preUnmarshal","getString","sym","unmarshalSymbol","thisHandle","argHandles","defineProperties","resultHandle","func","unmarshalFunction","r","obj","setPrototypeOf","unmarshalObject","unwrap","unwrapHandle","isHandleWrapped","defaultRegisteredObjects","Boolean","Error","EvalError","RangeError","ReferenceError","SyntaxError","TypeError","URIError","getOwnPropertyNames","Arena","_map","_registeredMap","_registeredMapDispose","_sync","_temporalSync","_symbol","_symbolHandle","_options","registerAll","registeredObjects","_unwrapResultAndUnmarshal","executePendingJobs","maxJobsToExecute","error","err","_unmarshal","expose","_marshal","global","sync","wrapped","_wrap","_unwrap","register","handleOrCode","_unwrapResult","unregister","unregisterAll","targets","startSync","endSync","_this4","registered","_this5","_this5$_options","_register","_this5$_register","unwrapped","wrappedHandle","_wrapHandle","_this6","_this6$_register","wrappedT","wrappedH","unwrappedT","_unwrapHandle","unwrappedH","_syncMode","obj2","proxyKeySymbol","proxyKeySymbolHandle","syncMode","rec","Proxy","Reflect","receiver","deleteProperty","wrap","_this7","res","wrapHandle","_this8"],"mappings":"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"}